<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity: Build Your Values Pledge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <style>
        html {
            font-size: 1.5vmin; /* Increased for better base readability */
        }
        ::-webkit-scrollbar{
            display: none;
        }
        
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --font-xs: 1.1rem;
            --font-sm: 1.4rem;
            --font-md: 1.6rem;
            --font-lg: 2rem;
            --font-xl: 4rem;
            --pad-sm: 1rem;
            --pad-md: 1.6rem;
            --pad-lg: 2.4rem;
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --progress-color: #FFFF00;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --header-font: 'Fredoka', 'Poppins', sans-serif;
            --body-font: 'Fredoka', 'Nunito', sans-serif;
            --border-radius: 1.4rem;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8;
            font-family: var(--body-font);
            font-size: var(--font-md);
        }

        #game-wrapper {
            width: 100%;
            max-width: 1200px;
            aspect-ratio: 16 / 9;
            box-shadow: 0 1.5rem 4rem var(--shadow-dark);
            overflow: hidden;
            position: relative;
            background: #fff;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: var(--pad-lg);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        /* --- HEADER --- */
        .game-header {
            width: 100%;
            background-color: var(--primary-color);
            padding: var(--pad-sm) var(--pad-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: absolute;
            top: 0; left: 0; z-index: 10;
            box-shadow: 0 0.2rem 1rem rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .game-header.visible { opacity: 1; }
        .game-header h1 { font-size: var(--font-lg); font-weight: 800; margin: 0; }
        .header-controls { display: flex; align-items: center; gap: var(--pad-md); }

        /* --- START SCREEN --- */
        #start-screen {
            background-image: url('images/gamebg.jpg');
            background-size: cover;
            background-position: center;
        }
        #start-screen h1 {
            font-size: var(--font-xl);
            color: var(--text-color-light);
            margin-bottom: 1.9rem;
            text-align: center;
            font-weight: 600;
            text-shadow: 0 0.4rem 1rem rgba(0,0,0,0.3);
        }
        .start-button {
            font-family: var(--header-font);
            background: var(--secondary-color); color: var(--text-color-light);
            font-weight: 600;
            font-size: var(--font-md);
            border: 0.3rem solid #fff;
            border-radius: 4.8rem;
            padding: var(--pad-sm) var(--pad-lg);
            margin-top: 1.6rem;
            cursor: pointer;
            text-shadow: 0 0.2rem 0 #b88b2a;
            transition: all 0.2s;
        }
        .start-button:hover { transform: scale(1.06); }

        /* ===== COMPLETION OVERLAY ===== */
        #completion-overlay {
            background-image: url('images/gamebg.jpg');
            background-size: cover; background-position: center; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 1rem; padding: 1rem;
        }
        .completion-title-banner {
            font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
            position: absolute;
            top: 2%;
        }
        
        #completion-image {
            width: 100%;
            max-width: 45vw;
            height: auto;
            min-height: 200px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-color-dark);
            border: 3px solid var(--secondary-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: var(--pad-lg);
            text-align: center;
            font-size: var(--font-md);
            line-height: 1.6;
            margin-bottom: 4rem;
        }
        #completion-image strong {
            color: var(--primary-color);
            font-weight: 800;
        }

        .completion-buttons {
            position: absolute; width: 100%; display: flex; justify-content: space-between;
            gap: 1rem; padding: 0 2rem 2rem 2rem; box-sizing: border-box;
            align-items: flex-end; margin-top: 0; bottom: 2%;
        }
        .completion-btn {
            font-family: var(--header-font); background: var(--secondary-color); color: #fff;
            font-weight: 500; 
            font-size: 1.3rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none;
            min-width: 8.75rem; /* 140px */
        }
        .completion-btn:hover { transform: scale(1.05); box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2); }
        
        /* --- GAME SCREEN & LAYOUT (VALUES PLEDGE) --- */
        #game-screen {
            justify-content: flex-start; padding: 0; overflow: hidden;
            background-color: #e9eef2;
            background-size: cover; background-position: center;
        }
        .game-content {
            width: 100%; height: 100%; padding: 7rem var(--pad-lg) var(--pad-lg);
            display: flex; gap: var(--pad-lg); align-items: flex-start; justify-content: center;
        }
        .notebook-container {
            background: #fffdf2; padding: var(--pad-lg); border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); width: 60%; height: 100%;
            display: flex; flex-direction: column; position: relative;
            overflow-y: auto; border-left: 3px solid #ff8a80; /* Red margin line */
        }
        .notebook-container h2 {
            font-family: var(--header-font); color: var(--primary-color);
            margin-bottom: var(--pad-md); text-align: center; font-size: var(--font-lg);
        }
        
        #pledge-form {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .pledge-sentence {
            font-size: var(--font-lg);
            line-height: 2.5;
            margin-bottom: var(--pad-lg);
            flex-grow: 1;
            text-align: center;
            padding-top: var(--pad-lg);
        }
        .pledge-sentence textarea {
            font-family: var(--body-font);
            font-size: inherit;
            border: none;
            border-bottom: 2px dotted var(--primary-color);
            background: transparent;
            padding: 0.2rem 0.5rem;
            resize: none;
            text-align: center;
            width: 15ch;
            vertical-align: baseline;
            transition: background-color 0.3s;
            overflow: hidden;
            line-height: 1.2;
        }
        .pledge-sentence textarea:focus {
            outline: none;
            background: rgba(93, 4, 178, 0.05);
        }
        .signature-field {
            margin-top: auto;
            padding-top: var(--pad-md);
            text-align: right;
            font-size: var(--font-md);
        }
        .signature-field label {
            font-weight: 700;
        }
        .signature-field input {
            width: 25ch;
            font-family: var(--body-font);
            font-size: inherit;
            border: none;
            border-bottom: 2px dotted var(--text-color-dark);
            background: transparent;
            padding: 0.2rem 0.5rem;
            transition: background-color 0.3s;
        }
        .signature-field input:focus {
            outline: none;
            background: rgba(51, 51, 51, 0.05);
        }
        
        .example-container {
            width: 35%; height: 100%; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(5px); padding: var(--pad-md); border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow-y: auto;
        }
        .example-container h3 {
            font-family: var(--header-font); color: var(--secondary-color); margin-bottom: var(--pad-sm);
            border-bottom: 2px solid var(--secondary-color); padding-bottom: 0.5rem; text-align: center;
        }
        .example-entry { margin-bottom: var(--pad-md); font-size: var(--font-sm); font-style: italic;}
        .example-entry strong { color: var(--primary-color); font-style: normal; }

        #submit-pledge-btn {
            background: var(--correct-color); color: var(--text-color-light); font-family: var(--header-font);
            font-size: var(--font-md); padding: var(--pad-sm) var(--pad-lg); border: none;
            border-radius: 3rem; cursor: pointer; margin-top: auto; /* Push to bottom */
            font-weight: 700; align-self: center; transition: transform 0.2s, box-shadow 0.2s;
            width: 60%; margin-top: 1.5rem;
        }
        #submit-pledge-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(92, 184, 92, 0.5); }
        
        /* ===== TAKEAWAYS OVERLAY ===== */
        #takeaways-overlay {
            background-image: url('images/gamebg.jpg'); 
            background-size: cover; background-position: center;
            flex-direction: column; 
            justify-content: center;
        }
        .takeaways-main-header {
            font-family: var(--header-font); color: white; font-size: 3.5rem;
            position: absolute; top: 5%; text-align: center; width: 100%;
            text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.3);
        }
        #takeaways-overlay .modal { 
            max-width: 800px; padding: 2rem; display: flex; 
            flex-direction: column; align-items: center; height: 50vh;
            overflow-y: auto;
            margin-top: 4rem;
            background: var(--card-background-light);
            border-radius: var(--border-radius);
            width: 90%;
        }
        .takeaways-header { color:var(--primary-color); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
        .takeaways-header h3 { font-family: var(--header-font); font-size: 1.8rem; color: var(--primary-color); }
        #takeaways-list { list-style-type: none; padding: 0; width: 100%; }
        #takeaways-list li {
            margin-bottom: 0.75rem; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            font-size: 1.1rem; 
            text-align: left;
            background: #f0f4f8;
            border-left: 4px solid var(--secondary-color);
        }
        
        .end-lesson-btn {
            background: var(--secondary-color); font-family: var(--header-font); color: #fff; font-weight: 900;
            font-size: 1.3rem; border: 3px solid #fff; border-radius: 3rem;
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            text-shadow: 0 2px 0 #b88b2a; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: auto; min-width: 180px; margin-top: 2rem;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .end-lesson-btn:hover { transform: scale(1.06); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }
        

        /* --- BUTTONS & MODALS --- */
        #help-button, .hint-icon { animation: glow-pulse-white 2.5s infinite ease-in-out; }
        #help-button {
            width: 4rem; height: 4rem; background: rgba(255, 255, 255, 0.2);
            border: 0.2rem solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s ease; padding: 0; color: white;
        }
        #help-button svg { width: 50%; height: 50%; fill: white; }
        #help-button:hover { transform: scale(1.1); animation: none; }
        #hint-button {
            position: absolute; bottom: 2rem; right: 2rem; z-index: 20;
            width: 5rem; height: 5rem; background: var(--secondary-color);
            border: 0.3rem solid white; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 0.4rem 1.5rem rgba(251, 176, 59, 0.4);
            animation: glow-pulse 2.5s infinite ease-in-out;
        }
        #hint-button:hover { animation: none; transform: scale(1.1); box-shadow: 0 0.6rem 2.5rem rgba(251, 176, 59, 0.8); }
        #hint-button svg { width: 2.4rem; height: 2.4rem; fill: white; }
        #hint-button.hidden { display: none; }

        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(0.5rem); z-index: 1000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-overlay.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #narration-modal, #help-modal, #hint-modal, #feedback-modal {  background: var(--card-background-light); padding: 2.5rem;
        border-radius: var(--border-radius); text-align: center;
        width: 90%; max-width: 600px;
        animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative; }
        #narration-title, #help-title, #hint-title, .feedback-title { color: var(--primary-color); font-size: var(--font-lg); margin-bottom: 2.4rem; display: flex; align-items: center; justify-content: center; gap: 1rem;font-weight: 600;}
        #narration-text, #help-modal-text, #hint-modal-text, #feedback-modal-text { font-size: var(--font-md); line-height: 1.6; color: var(--text-color-dark); margin-bottom: 3.2rem; }
        #help-modal-text p, #hint-modal-text p, #help-modal-text ul, #hint-modal-text ul { margin-bottom: 1rem; list-style-position: inside; }
        #help-modal-text, #hint-modal-text { text-align: left; }
        #narration-text { text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--primary-color); line-height: 1.5; color: var(--text-color-dark); }
        #continue-narration-btn, #help-modal-btn, #hint-modal-btn, #feedback-modal-btn { width: 100%; padding: 1.6rem; font-size: 1.8rem; font-weight: 700; border: none; border-radius: 1.2rem; cursor: pointer; color: #ffffff; transition: transform 0.2s, box-shadow 0.2s; }
        #continue-narration-btn:hover, #help-modal-btn:hover, #hint-modal-btn:hover, #feedback-modal-btn:hover { transform: scale(1.03); }
        #continue-narration-btn, #help-modal-btn { background: var(--primary-color); }
        #hint-modal-btn { background: var(--secondary-color); }
        @keyframes slideIn { from { transform: translateY(3rem) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        #hint-modal { border-top-color: var(--secondary-color); }
        #hint-title { color: var(--secondary-color); }

        #feedback-modal.correct-feedback { border-color: var(--correct-color);  }
        #feedback-modal.incorrect-feedback { border-color: var(--incorrect-color); }
        #feedback-modal.correct-feedback .feedback-title { color: var(--correct-color); }
        #feedback-modal.incorrect-feedback .feedback-title { color: var(--incorrect-color); }
        .feedback-title svg { width: var(--font-lg); height: var(--font-lg); }
        #feedback-modal.correct-feedback #feedback-modal-btn { background: var(--correct-color); }
        #feedback-modal.incorrect-feedback #feedback-modal-btn { background: var(--incorrect-color); }
        
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 176, 59, 0.5), 0 0 20px rgba(251, 176, 59, 0.3); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(251, 176, 59, 0.8), 0 0 30px rgba(251, 176, 59, 0.5); transform: scale(1.1); }
        }
        @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.7); transform: scale(1.1); }
        }

        /* --- Media Query for smaller screens --- */
        @media (max-width: 991px) {
            #completion-image {
                max-width: 65vw;
                width: 100%;
                margin-top: 3rem;
            }
            #takeaways-overlay .modal{ height: 60vh; }
        }
        @media (max-width: 768px), (max-height: 500px) {
            body { padding: 0; }
            #game-wrapper { aspect-ratio: unset; width: 100vw; height: 100vh; border-radius: 0; box-shadow: none; }
            html { font-size: 2.8vmin; } /* Adjusted for better mobile scaling */
            .game-content { flex-direction: column; padding: 7rem var(--pad-sm) var(--pad-sm) var(--pad-sm); align-items: center; }
            .notebook-container, .example-container { width: 95%; height: auto; }
            .notebook-container { flex-grow: 1; }
            .example-container { display: none; } /* Hide example on small screens to save space */
            .completion-buttons { gap: 0.75rem; position: static; padding: 1rem; }
            .pledge-sentence { font-size: var(--font-md); }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div class="game-header">
                <h1>Build Your Values Pledge</h1>
                <div class="header-controls">
                    <button id="help-button" class="help-icon" title="Help">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </button>
                </div>
            </div>

            <div id="start-screen" class="screen">
                <h1>Build Your Values Pledge</h1>
                <button class="start-button">Start Activity</button>
            </div>

            <div id="game-screen" class="screen hidden">
                <div class="game-content">
                    </div>
                 <button id="hint-button" class="hint-icon hidden" title="Get a Hint">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/></svg>
                </button>
            </div>

            <div id="completion-overlay" class="screen hidden">
                <h2 class="completion-title-banner">Activity Conclusion</h2>
                <div id="completion-image">
                    </div>
                <div class="completion-buttons">
                    <button class="completion-btn" id="previous-activity-btn">Previous Activity</button>
                    <button class="completion-btn" id="restart-activity-btn">Restart Activity</button>
                    <button class="completion-btn" id="key-takeaways-btn">Key Takeaways</button>
                </div>
            </div>

            <div id="takeaways-overlay" class="screen hidden">
                <h2 class="takeaways-main-header">Lesson Complete!</h2>
                <div class="modal">
                    <div class="takeaways-header">
                        <h3>Key Takeaways</h3>
                    </div>
                    <ul id="takeaways-list"></ul>
                </div>
                <button class="end-lesson-btn" onclick="sendEvent(LessonEvent.END_LESSON, {lessonName: 'Appreciating the Role of Values in Personality Development: Lesson 3'})">Exit Lesson</button>
            </div>

            <div id="feedback-modal-overlay" class="modal-overlay hidden">
                <div id="feedback-modal">
                    <div class="feedback-title" id="feedback-title"></div>
                    <div id="feedback-modal-text"></div>
                    <button id="feedback-modal-btn">Continue</button>
                </div>
            </div>

            <div id="narration-modal-overlay" class="modal-overlay hidden">
                <div id="narration-modal">
                    <h2 id="narration-title">Activity Introduction</h2>
                    <div id="narration-text"></div>
                    <button id="continue-narration-btn">Continue</button>
                </div>
            </div>

            <div id="help-modal-overlay" class="modal-overlay hidden">
                <div id="help-modal">
                    <h2 id="help-title">Learner Instructions</h2>
                    <div id="help-modal-text"></div>
                    <button id="help-modal-btn">Got It!</button>
                </div>
            </div>

             <div id="hint-modal-overlay" class="modal-overlay hidden">
                <div id="hint-modal">
                    <h2 id="hint-title">Here's a Hint...</h2>
                    <div id="hint-modal-text"></div>
                    <button id="hint-modal-btn">Got it!</button>
                </div>
            </div>
            
            <audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
            <audio id="outro-audio" src="audio/outro.mp3" preload="auto"></audio>
            <audio id="correct-audio" src="audio/ding.mp3" preload="auto"></audio>
            <audio id="incorrect-audio" src="audio/buzz.mp3" preload="auto"></audio>

        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONSTANTS ---
    const endScreenDelay = 500;

    // --- DOM ELEMENTS ---
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const gameContentContainer = gameScreen.querySelector('.game-content');
    const completionOverlay = document.getElementById('completion-overlay');
    const completionImageContainer = document.getElementById('completion-image');
    const takeawaysOverlay = document.getElementById('takeaways-overlay');
    const takeawaysList = document.getElementById('takeaways-list');
    const gameHeader = document.querySelector('.game-header');
    const startBtn = document.querySelector('.start-button');
    const narrationModalOverlay = document.getElementById('narration-modal-overlay');
    const narrationText = document.getElementById('narration-text');
    const continueNarrationBtn = document.getElementById('continue-narration-btn');
    const modalOverlay = document.getElementById('feedback-modal-overlay');
    const modal = document.getElementById('feedback-modal');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackText = document.getElementById('feedback-modal-text');
    const feedbackModalBtn = document.getElementById('feedback-modal-btn');
    const helpButton = document.getElementById('help-button');
    const helpModalOverlay = document.getElementById('help-modal-overlay');
    const helpModalText = document.getElementById('help-modal-text');
    const helpModalBtn = document.getElementById('help-modal-btn');
    const hintButton = document.getElementById('hint-button');
    const hintModalOverlay = document.getElementById('hint-modal-overlay');
    const hintModalText = document.getElementById('hint-modal-text');
    const hintModalBtn = document.getElementById('hint-modal-btn');
    const restartActivityBtn = document.getElementById('restart-activity-btn');
    const keyTakeawaysBtn = document.getElementById('key-takeaways-btn');
    const introAudio = document.getElementById('intro-audio');
    const outroAudio = document.getElementById('outro-audio');
    const correctAudio = document.getElementById('correct-audio');
    const incorrectAudio = document.getElementById('incorrect-audio');

    // --- ACTIVITY DATA ---
    const activityContent = {
        intro: "It is now your turn to make a promise. In this activity, you will create a values pledge that guides how you live at school, home, and in the community.",
        instructions: "<p>Fill in the pledge by choosing one value, explaining why it matters, and writing how you will live it out.</p>",
        hints: `
            <ul>
                <li>Think of a value that is important to you, such as <strong>respect, honesty, or responsibility</strong>.</li>
                <li>How will you show this value at home, in school, or in your community?</li>
            </ul>
        `,
        feedback: {
            incomplete: "Your pledge is not complete. Please fill in all the blank sections and add your signature to create your personal promise.",
            complete: "Excellent! You've created a meaningful values pledge. This promise will help guide your actions."
        },
        takeaways: [
            "Values are beliefs that guide choices and behaviour.",
            "Values like empathy, integrity, and responsibility shape positive personality traits.",
            "Stories of people such as Thandi show that values can change entire communities.",
            "Creating pledges and sharing values helps you live with purpose and confidence."
        ]
    };

    const icons = {
        correct: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
        incorrect: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`
    };

    function initializeGame() {
        narrationText.innerHTML = activityContent.intro;
        helpModalText.innerHTML = activityContent.instructions;
        hintModalText.innerHTML = activityContent.hints;
        completionImageContainer.innerHTML = ''; // Clear previous summary

        gameContentContainer.innerHTML = ''; // Clear previous content

        const notebook = document.createElement('div');
        notebook.className = 'notebook-container';
        
        const form = document.createElement('form');
        form.id = 'pledge-form';
        form.addEventListener('submit', e => e.preventDefault());
        form.innerHTML = `
            <h2>My Values Pledge</h2>
            <div class="pledge-sentence">
                I value <textarea id="pledge-value" rows="1" placeholder="a value"></textarea> 
                because <textarea id="pledge-reason" rows="1" placeholder="a reason"></textarea>. 
                I will show it by <textarea id="pledge-action" rows="1" placeholder="an action"></textarea>.
            </div>
            <div class="signature-field">
                <label for="pledge-signature">Signature:</label>
                <input type="text" id="pledge-signature" name="pledge-signature" placeholder="Your Name">
            </div>
        `;

        const submitBtn = document.createElement('button');
        submitBtn.id = 'submit-pledge-btn';
        submitBtn.type = 'button';
        submitBtn.textContent = 'Make My Pledge';
        submitBtn.addEventListener('click', checkCompletion);
        
        notebook.appendChild(form);
        notebook.appendChild(submitBtn);

        const exampleContainer = document.createElement('div');
        exampleContainer.className = 'example-container';
        exampleContainer.innerHTML = `
            <h3>Pledge Examples</h3>
            <div class="example-entry">
                <p>“I value <strong>respect</strong> because <strong>everyone deserves to be heard</strong>. I will show it by <strong>listening without interrupting</strong>.”</p>
            </div>
            <div class="example-entry">
                <p>“I value <strong>responsibility</strong> because <strong>trust depends on it</strong>. I will show it by <strong>completing my duties on time</strong>.”</p>
            </div>
        `;
        
        gameContentContainer.appendChild(notebook);
        gameContentContainer.appendChild(exampleContainer);
    }
    
    function checkCompletion() {
        const inputs = document.querySelectorAll('#pledge-form textarea, #pledge-form input');
        let allFilled = true;
        inputs.forEach(input => {
            if (input.value.trim() === '') {
                allFilled = false;
            }
        });

        if (allFilled) {
            showFeedback(true, activityContent.feedback.complete);
        } else {
            showFeedback(false, activityContent.feedback.incomplete);
        }
    }

    function generatePledgeSummary() {
        const value = document.getElementById('pledge-value').value.trim();
        const reason = document.getElementById('pledge-reason').value.trim();
        const action = document.getElementById('pledge-action').value.trim();
        const signature = document.getElementById('pledge-signature').value.trim();

        const summaryHTML = `
            <p style="font-size: var(--font-lg); line-height: 1.5;">
                I value <strong>${value}</strong> because <strong>${reason}</strong>. 
                I will show it by <strong>${action}</strong>.
            </p>
            <p style="text-align: right; margin-top: 2rem; font-style: italic; font-size: var(--font-md);">
                Signed: <strong>${signature}</strong>
            </p>
        `;
        completionImageContainer.innerHTML = summaryHTML;
    }


    function switchScreen(hideScreen, showScreen) {
        hideScreen.classList.add('hidden');
        if (showScreen === gameScreen) {
            gameHeader.classList.add('visible');
            hintButton.classList.remove('hidden');
        } else if (hideScreen === gameScreen) {
            gameHeader.classList.remove('visible');
            hintButton.classList.add('hidden');
        }
        setTimeout(() => showScreen.classList.remove('hidden'), 50);
    }

    function showFeedback(isCorrect, message) {
        let titleText;
        let sound;
        if (isCorrect) {
            titleText = "Pledge Made!";
            sound = correctAudio;
            modal.className = 'correct-feedback';
            feedbackTitle.innerHTML = `${icons.correct} ${titleText}`;
            feedbackModalBtn.onclick = handleFinishClick;
        } else {
            titleText = "Keep Going...";
            sound = incorrectAudio;
            modal.className = 'incorrect-feedback shake';
            feedbackTitle.innerHTML = `${icons.incorrect} ${titleText}`;
            feedbackModalBtn.onclick = handleContinueClick;
        }
        feedbackText.textContent = message;
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Audio play failed.", e));
        modal.addEventListener('animationend', () => modal.classList.remove('shake'), { once: true });
        modalOverlay.classList.remove('hidden');
    }

    const handleFinishClick = () => {
        modalOverlay.classList.add('hidden');
        generatePledgeSummary(); // Generate summary before switching screen
        setTimeout(() => {
            switchScreen(gameScreen, completionOverlay);
            outroAudio.play().catch(e => console.log("Outro audio play failed.", e));
        }, endScreenDelay);
    };

    const handleContinueClick = () => {
        modalOverlay.classList.add('hidden');
    };

    function showNarration() {
        introAudio.currentTime = 0;
        introAudio.play().catch(e => console.log("Intro audio play failed.", e));
        narrationModalOverlay.classList.remove('hidden');
    }
    
    function stopAllAudio() {
        [introAudio, outroAudio, correctAudio, incorrectAudio].forEach(audio => {
            if (audio && !audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }
        });
    }

    function restartGame() {
        stopAllAudio();
        // Hide all overlays before restarting
        [completionOverlay, takeawaysOverlay].forEach(screen => screen.classList.add('hidden'));
        initializeGame();
        switchScreen(startScreen, gameScreen); // Go back to game, not start
        // To restart from the very beginning (start screen), use:
        // switchScreen(completionOverlay, startScreen);
        // switchScreen(takeawaysOverlay, startScreen);
    }

    // --- EVENT LISTENERS ---
    startBtn.addEventListener('click', () => {
        switchScreen(startScreen, gameScreen);
        initializeGame();
        showNarration();
        if (typeof sendEvent !== 'undefined' && typeof ActivityEvent !== 'undefined') {
            sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Build Your Values Pledge' });
        }
    });

    restartActivityBtn.addEventListener('click', () => {
        // More robust restart logic
        stopAllAudio();
        const currentVisibleScreen = document.querySelector('.screen:not(.hidden)');
        if (currentVisibleScreen) {
            switchScreen(currentVisibleScreen, gameScreen);
        } else {
            gameScreen.classList.remove('hidden'); // Fallback
        }
        initializeGame();
    });
    
    keyTakeawaysBtn.addEventListener('click', () => {
        stopAllAudio();
        takeawaysList.innerHTML = ''; // Clear previous list
        activityContent.takeaways.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            takeawaysList.appendChild(li);
        });
        switchScreen(completionOverlay, takeawaysOverlay);
    });

    document.querySelectorAll('.completion-buttons button').forEach(button => {
        button.addEventListener('click', stopAllAudio);
    });

    continueNarrationBtn.addEventListener('click', () => {
        narrationModalOverlay.classList.add('hidden');
        stopAllAudio();
    });

    helpButton.addEventListener('click', () => helpModalOverlay.classList.remove('hidden'));
    helpModalBtn.addEventListener('click', () => helpModalOverlay.classList.add('hidden'));
    
    hintButton.addEventListener('click', () => hintModalOverlay.classList.remove('hidden'));
    hintModalBtn.addEventListener('click', () => hintModalOverlay.classList.add('hidden'));

    document.getElementById('previous-activity-btn').addEventListener('click', () => {
        if (typeof sendEvent !== 'undefined' && typeof ActivityEvent !== 'undefined') {
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Build Your Values Pledge' });
        }
        window.location.href = "../ACTIVITY3/index.html"; // Assuming previous is activity 3
    });
    
    // The next activity button is now the takeaways button, so no next activity navigation here.
});
</script>
<script src = "../eventSender.js"></script>
</body>
</html>