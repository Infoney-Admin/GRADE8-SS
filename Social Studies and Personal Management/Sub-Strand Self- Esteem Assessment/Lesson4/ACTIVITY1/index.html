<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Self-Esteem Toolkit â€“ Activity</title>
    <style>
        /* Font Imports */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar {
            display: none;
        }
        /* Root Variables */
        :root {
            --font-xs: 1.1rem;
            --font-sm: 1.4rem;
            --font-md: 1.6rem;
            --font-lg: 2rem;
            --font-xl: 4rem;
            --pad-sm: 1rem;
            --pad-md: 1.6rem;
            --pad-lg: 2.4rem;
            --primary-color: #5D04B2;
            --secondary-color: #fbb03b;
            --progress-color: #ffff00;
            --correct-color: #4caf50;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --header-font: 'Fredoka', sans-serif;
            --body-font: var(--header-font);
        }

        /* Proportional Scaling System Setup */
        html {
            /* Establishes a master scaling unit relative to the viewport's smallest dimension. */
            font-size: 1.8vmin;
        }

        /* Global Reset & Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent body scrollbars */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f4f8;
            font-family: var(--body-font);
        }

        #game-wrapper {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
            max-width: 1200px;
            margin: auto;
            position: relative;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background-color: var(--primary-color);
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            overflow: hidden;
            padding: 1rem;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        
    /* ===== START SCREEN ===== */
    #start-screen {
      color: var(--text-color-light);
      text-align: center;
      padding: 2rem;
      background-image: url('images/gamebg.jpg');
      background-size: cover;
      background-position: center;
      justify-content: center;
      align-items: center;
    }
    
    #start-screen h1 {
      color: var(--text-color-light);
      font-size: 4rem;
      font-family: var(--header-font);
      text-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.4);
      font-weight: 500;
    }
    
    .start-button {
        font-family: var(--header-font);
        background: var(--secondary-color);
        color: var(--text-color-light);
        font-weight: 500;
        font-size: 1.5rem;
        border: 3px solid #fff;
        border-radius: 4.8rem;
        padding: var(--pad-sm) var(--pad-lg);
        margin-top: 1.6rem;
        cursor: pointer;
        text-shadow: 0 0.2rem 0 #b88b2a;
        transition: all 0.2s;
    }
    
    .start-button:hover {
      transform: scale(1.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
    }
    
        /* Game Screen Styles */
        #game-screen {
             justify-content: flex-start;
             padding: 0;
             display: flex;
             flex-direction: column;
        }
        
        /* Header / Top Bar */
        .game-top-section { 
          width: 100%;
          background-color: #5D04B2;
          padding: 0.75rem 1.25rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: #fff;
          z-index: 10;
          box-shadow: 0 0.1rem 0.5rem rgba(0,0,0,0.2);
          flex-shrink: 0;
        }
        
        #game-title {
          font-size: 1.8rem;
          font-weight: 600;
          margin: 0;
        }
        
        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        /* Progress Bar */
         #progress-container {
            width: 12.5rem;
            background-color: rgba(255,255,255,0.3);
            border-radius: 1rem;
            height: 1.25rem;
            border: 2px solid #fff;
            position: relative;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: var(--progress-color);
            border-radius: 0.8rem;
            transition: width 0.5s ease;
        }

        #progress-text {
            color: var(--text-color-light);
            font-weight: 700;
            font-size: 1rem;
            text-shadow: 0.0625rem 0.0625rem 0.125rem rgba(0,0,0,0.6);
            white-space: nowrap;
        }
            
        @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 1rem rgba(255, 255, 255, 0.7), 0 0 2rem rgba(255, 255, 255, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 2rem rgba(255, 255, 255, 1), 0 0 3rem rgba(255, 255, 255, 0.7); transform: scale(1.1); }
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 176, 59, 0.5), 0 0 20px rgba(251, 176, 59, 0.3); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(251, 176, 59, 0.8), 0 0 30px rgba(251, 176, 59, 0.5); transform: scale(1.1); }
        }

        .instructions-icon {
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.2);
            border: 0.15rem solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            flex-shrink: 0;
            animation: glow-pulse-white 2s infinite ease-in-out;
        }
        .instructions-icon svg { width: 60%; height: 60%; fill: white; }
        .instructions-icon:hover { 
            transform: scale(1.1);
            animation-play-state: paused;
        }
        /* HINT BUTTON (copied from ACTIVITY2 for consistent look/position) */
        .hint-icon { animation: glow-pulse 2.5s infinite ease-in-out; }
        #hint-button {
            position: absolute; bottom: 2rem; right: 2rem; z-index: 20;
            width: 4rem; height: 4rem; background: var(--secondary-color);
            border: 3px solid white; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 0.4rem 1.5rem rgba(251, 176, 59, 0.4);
            animation: glow-pulse 2.5s infinite ease-in-out;
        }
        #hint-button:hover { animation: none; transform: scale(1.1); box-shadow: 0 0.6rem 2.5rem rgba(251, 176, 59, 0.8); }
        #hint-button svg { width: 2.4rem; height: 2.4rem; fill: white; }
        #hint-button.hidden { display: none; }
        
        /* DRAG AND DROP AREA */
        .drag-drop-area {
            width: 100%;
            flex-grow: 1;
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            padding: 2rem;
            gap: 2rem;
            background-color: #fff;
        }

        #strategy-cards-container, #toolbox-container {
            width: 45%;
            padding: 1.5rem;
            background: #EAE6F0;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 58vh;
            overflow-y:auto;
        }

        .container-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 0.5rem;
            text-shadow: 0 1px 1px rgba(255,255,255,0.7);
        }

        #cards-pool, #toolbox-dropzone {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 0.5rem;
            min-height: 10rem;
            transition: background-color 0.3s ease;
        }

        #toolbox-dropzone {
            background: rgba(0,0,0,0.1);
            border: 2px dashed rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            align-content: flex-start;
            gap: 1rem;
            padding: 1rem;
            color: rgba(0,0,0,0.4);
            font-size: 1.2rem;
            font-weight: 500;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: pointer;
            touch-action: manipulation;
            overflow-y: auto;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            height: 100%;
        }
        
        #toolbox-dropzone.drag-over {
            background-color: rgba(93, 4, 178, 0.2);
            border-color: var(--primary-color);
            border-style: solid;
        }

        .strategy-card {
            background-color: var(--card-background-light);
            color: var(--text-color-dark);
            border-radius: 0.75rem;
            padding: 1.2rem;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            border-left: 5px solid var(--secondary-color);
        }

        .strategy-card.dragging {
            opacity: 0.5;
            transform: scale(1.05) rotate(3deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        #toolbox-dropzone .strategy-card {
            margin-bottom: 0;
            height: 6rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #toolbox-dropzone .strategy-card.expanded {
            height: auto;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .card-explanation {
            font-size: 1.2rem;
            line-height: 1.5;
            color: #555;
            margin-top: 0;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s 0.1s ease-in-out, margin-top 0.5s ease-in-out;
        }

        .strategy-card.expanded .card-explanation {
            max-height: 20rem; /* Arbitrary large value */
            opacity: 1;
            margin-top: 0.8rem;
        }
        
        /* MODALS */
        .overlay {
          position: absolute; top: 0; left: 0; width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.4);
          backdrop-filter: blur(0.5rem);
          z-index: 100;
          display: flex; justify-content: center; align-items: center;
          animation: fadeIn 0.3s ease;
        }
        .overlay.hidden { display: none; }
        
        .modal {
          background: var(--card-background-light, #fff);
          padding: 2.5rem;
          border-radius: 1rem;
          text-align: center;
          width: 90%; 
          max-width: 50rem;
          animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          position: relative;
        }
        
        .modal .modal-title {
          font-size: 2.5rem; font-weight: 600; margin-bottom: 1.5rem;
          color: var(--primary-color);
        }
        .modal p { font-size: 1.5rem; line-height: 1.6; color: var(--text-color-dark, #333); }
        .modal ul { list-style-position: inside; text-align: left; }
        .modal ul li { margin-bottom: 0.5rem; font-size: 1.2rem; line-height: 1.6; }

        #activity-description-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #activity-description-overlay .modal .modal-title { color: var(--primary-color); }
        #activity-description-overlay .modal p {
          text-align: left; background: #f8f9fa; padding: 1.5rem;
          border-radius: 0.75rem; border-left: 0.4rem solid var(--primary-color);
        }
        
        #game-instructions-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #game-instructions-overlay .modal .modal-title { color: var(--primary-color); }
        #game-instructions-overlay .modal p, #game-instructions-overlay .modal ul {
            text-align: left;
            background-color: #f8f9fa;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.2rem; line-height: 1.6;
        }
        /* HINT MODAL SPECIFIC STYLING */
        #hint-modal { border-top: 0.5rem solid var(--secondary-color); }
        #hint-modal .modal-title { color: var(--secondary-color); }
        #hint-modal .modal-close-btn { background: var(--secondary-color); }
        
        .modal-close-btn {
          width: 100%; padding: 1.2rem; font-size: 1.5rem; font-weight: 700;
          border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
          background-color: var(--primary-color);
          transition: transform 0.2s, box-shadow 0.2s;
          margin-top: 1.5rem;
        }
        
        .modal-close-btn:hover { transform: scale(1.02); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(3rem) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        
        /* Completion Screen */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg');
            background-size: cover;
            background-position: center;
            color: #fff;
            z-index: 200;
        }
        .completion-header { 
          font-size: 4rem;
          margin-bottom: 1rem;
          text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.2);
          text-align: center;
          position: absolute;
          top: 3%;
          font-weight: 600;
        }
        .completion-modal-content {
            background: transparent;
            box-shadow: none;
            width: 80%;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: visible;
            margin-top: 0rem;
            border: none;
            margin-top: 4rem;
        }
        .completion-image {
            display: block;
            margin: 0 auto 1.5rem auto;
            max-width: 60vw;
            width: 80%;
            height: auto;
            object-fit: contain;
            animation: fadeIn 0.5s ease-out;
            border: 2px solid var(--secondary-color);
            border-radius: 1rem;
        }
        .completion-buttons-footer { 
          position: absolute;
          bottom: 1.5rem;
          left: 0; right: 0;
          width: 100%;
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 2rem;
          padding: 0 1.25rem;
        }
        .completion-btn { 
          font-family: var(--header-font);
          background: #FBB03B;
          color: #fff;
          font-weight: 500;
          font-size: 1.3rem;
          border: 3px solid #fff;
          border-radius: 3rem;
          padding: 0.75rem 2.5rem;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 0.4rem 0.8rem rgba(0,0,0,0.2);
          text-shadow: 0 0.2rem 0 #b88b2a;
          text-decoration: none;
          min-width: 14rem;
          text-align: center;
        }
        .completion-btn:hover { transform: scale(1.06); box-shadow: 0 0.6rem 2.4rem rgba(0,0,0,0.18); }
        
        /* ====== KEY TAKEAWAYS SCREEN ====== */
        .end-lesson-screen {
            display: flex; flex-direction: column; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; justify-content: center; align-items: center;
            padding: 2rem; background-color: var(--primary-color); text-align: center; color: white; gap: 1.5rem;
            z-index: 300;
        }
        .end-lesson-screen h2 { font-size: 2.5rem; text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.2); }
        #key-takeaways-overlay{
            background-image: url(images/gamebg.jpg);
            background-size: cover;
            background-position: center;
        }
        .takeaways-container {
            background-color: white; color: var(--text-color-dark);
            border-radius: 1rem; padding: 1.5rem 2rem; max-width: 50rem;
            width: 90%; border-top: 0.3rem solid var(--secondary-color);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
        }
        .takeaways-title { font-size: 2rem; color: var(--primary-color); margin-bottom: 1.2rem; font-weight: 700; }
        .takeaways-list { list-style-type: none; padding: 0; text-align: left; }
        .takeaways-list li { position: relative; padding-left: 2rem; margin-bottom: 0.8rem; font-size: 1.2rem; line-height: 1.5; }
        .takeaways-list li::before { content: "âœ“"; color: var(--correct-color); position: absolute; left: 0; top: 0; font-size: 1.2rem; font-weight: bold; }
        .primary-action-btn {
            background: var(--secondary-color); color: #fff; font-weight: 900; font-size: 1.25rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; padding: 0.75rem 2.5rem;
            cursor: pointer; text-shadow: 0 0.125rem 0 #b88b2a; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2); text-decoration: none;
        }
        .primary-action-btn:hover { transform: scale(1.06); }

        /* MEDIA QUERIES */
        @media (max-aspect-ratio: 16/9) {
            #game-wrapper {
                max-height: 100%;
                max-width: calc(100vh * 16 / 9);
            }
        }
        @media (max-width: 1200px) {
            html { font-size: 2.2vmin; }
        }
        
        @media (max-width: 1000px) {
            html{ font-size: 3vmin; }
            #game-wrapper {
                width: 100vw; height: 100vh; min-width: 100vw; min-height: 100vh;
                border-radius: 0; max-width: none; aspect-ratio: unset;
            }
            .completion-image { width: 60%; }
              #strategy-cards-container, #toolbox-container {
                height: 80vh;
            }
        }
        
        @media (max-width: 768px) {
            html { font-size: 3vmin; }
            .drag-drop-area {
                padding: 1rem;
                gap: 1rem;
                overflow-y: auto;
            }
          
            .completion-header { font-size: 3rem; }
            .completion-buttons-footer { gap: 1rem; bottom: 1rem; }
            .completion-image { width: 80%; }
            .takeaways-list li { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="start-screen" class="screen">
                <h1>Build Your Self-Esteem Toolkit</h1>
                <button class="start-button" onclick="startGame();">Start Activity</button>
            </div>

            <div id="game-screen" class="screen hidden">
                <div class="game-top-section">
                    <h1 id="game-title">Self-Esteem Toolkit</h1>
                    <div class="progress-wrapper">
                         <div id="progress-container">
                            <div id="progress-bar"></div>
                        </div>
                        <div id="progress-text">0 / 6</div>
                        <div class="instructions-icon" onclick="showGameInstructions()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="drag-drop-area">
                    <div id="strategy-cards-container">
                        <h2 class="container-title">Strategy Cards</h2>
                        <div id="cards-pool"></div>
                    </div>
                    <div id="toolbox-container">
                        <h2 class="container-title">My Toolkit</h2>
                        <div id="toolbox-dropzone"></div>
                    </div>
                </div>
                <button id="hint-button" class="hint-icon hidden" title="Get a Hint">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/></svg>
                </button>
            </div>

            <div id="activity-description-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Activity Introduction</h2>
                    <p>Just as builders need the right tools, so do we when growing self-esteem. In this activity, you will collect strategies that strengthen confidence and resilience. By the end, you will have your own toolkit for daily growth.</p>
                    <button class="modal-close-btn" onclick="closeActivityDescription();">Continue</button>
                </div>
            </div>
            
            <div id="game-instructions-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Learner Instructions</h2>
                    <p>Drag each strategy card into your toolkit. Click on the card to read the explanation and see how it can be applied in daily life.</p>
                    <button class="modal-close-btn" onclick="closeGameInstructions()">Got It!</button>
                </div>
            </div>

            <div id="hint-modal-overlay" class="overlay hidden">
                <div class="modal" id="hint-modal">
                    <h2 class="modal-title">Here's a Hint</h2>
                    <div id="hint-modal-text" style="text-align:left; padding:1rem; border-radius:0.5rem;color:var(--text-color-dark);">
                        <ul>
                            <li>Think of what helps you feel capable, supported, or motivated.</li>
                            <li>Choose strategies you can practise daily.</li>
                            <li>Remember that mistakes and challenges can be used as growth opportunities.</li>
                        </ul>
                    </div>
                    <button class="modal-close-btn" id="hint-modal-btn">Got it!</button>
                </div>
            </div>

            <div id="completion-overlay" class="screen hidden">
                <h2 class="completion-header">Activity Conclusion</h2>
                <div class="modal-content completion-modal-content">
                     <img src="images/complete.jpg" alt="Illustration of a person with a completed toolkit" class="completion-image" onerror="this.src='https://placehold.co/400x300/5D04B2/ffffff?text=Toolkit+Complete!'; this.onerror=null;">
                </div>       
                <div class="completion-buttons-footer">
                    <button class="completion-btn" onclick="restartGame()">Restart Activity</button>
                    <button class="completion-btn" onclick="goToNextActivity()">Next Activity</button>
                </div>
            </div>

            <div id="key-takeaways-overlay" class="screen hidden end-lesson-screen">
                <h2>Activity Complete!</h2>
                <div class="takeaways-container">
                    <div class="takeaways-title">Key Takeaways</div>
                    <ul class="takeaways-list">
                        <li><b>Proactive Growth:</b> Building self-esteem is an active process that requires using consistent strategies like positive self-talk and goal setting.</li>
                        <li><b>Resilience is Key:</b> Accepting mistakes and seeking support are powerful tools for bouncing back from challenges and growing stronger.</li>
                        <li><b>Mindset Matters:</b> Practising gratitude and challenging yourself can shift your perspective, helping you recognize your strengths and potential.</li>
                        <li><b>Personal Toolkit:</b> Your self-esteem toolkit is unique to you. Regularly using these tools helps build lasting confidence.</li>
                    </ul>
                </div>
                <button class="primary-action-btn" onclick="closeKeyTakeaways()">Exit Lesson</button>
            </div>
        </div>
    </div>

    <audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
    <audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
    <audio id="outro-audio" src="audio/outro.mp3" preload="auto"></audio>

    <script>
        // --- DATA ---
        const activityData = [
            { id: 'self-talk', title: 'Positive self-talk', explanation: 'Replacing negative inner words with encouraging ones strengthens confidence and resilience.' },
            { id: 'goals', title: 'Set realistic goals', explanation: 'Breaking goals into small steps builds progress and boosts self-esteem.' },
            { id: 'support', title: 'Seek support', explanation: 'Friends, teachers, or family members can offer encouragement and guidance.' },
            { id: 'grateful', title: 'Be grateful', explanation: 'Practising gratitude shifts focus to strengths and positive experiences.' },
            { id: 'mistakes', title: 'Accept mistakes', explanation: 'Recognising that errors are lessons, not failures, encourages growth.' },
            { id: 'challenge', title: 'Challenge yourself', explanation: 'Stepping outside comfort zones helps you grow stronger and more confident.' }
        ];
        const TOTAL_ACTIVITIES = activityData.length;

        // --- STATE ---
        let completedActivities = new Set();
        let currentlyDragging = null;
        let isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const completionOverlay = document.getElementById('completion-overlay');
        const keyTakeawaysOverlay = document.getElementById('key-takeaways-overlay');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const cardsPool = document.getElementById('cards-pool');
        const toolboxDropzone = document.getElementById('toolbox-dropzone');
        
        const overlays = {
            activityDescription: document.getElementById('activity-description-overlay'),
            gameInstructions: document.getElementById('game-instructions-overlay'),
        };
        const sounds = {
            ding: document.getElementById('ding-sound'),
            intro: document.getElementById('intro-audio'),
            outro: document.getElementById('outro-audio'),
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeGame();
            if (isTouchDevice) {
                document.addEventListener('touchmove', handleUnifiedMove, { passive: false });
                document.addEventListener('touchend', handleUnifiedEnd);
            } else {
                document.addEventListener('dragend', handleUnifiedEnd);
            }
        });

        function initializeGame() {
            cardsPool.innerHTML = ''; 
            toolboxDropzone.innerHTML = '';
            
            activityData.forEach(item => {
                const card = createStrategyCard(item);
                cardsPool.appendChild(card);
            });
            addDragDropListeners();
            updateProgress();
        }
        
        function createStrategyCard(item) {
            const card = document.createElement('div');
            card.className = 'strategy-card';
            card.id = item.id;
            card.draggable = true;
            card.innerHTML = `
                <div class="card-title">${item.title}</div>
                <div class="card-explanation">${item.explanation}</div>
            `;
            return card;
        }
        
        function addDragDropListeners() {
            const cards = document.querySelectorAll('.strategy-card');
            cards.forEach(card => {
                if (isTouchDevice) {
                    card.addEventListener('touchstart', handleUnifiedStart);
                } else {
                    card.addEventListener('dragstart', handleUnifiedStart);
                }
                card.addEventListener('click', () => handleCardClick(card));
            });
            
            toolboxDropzone.addEventListener('dragover', handleUnifiedOver);
            toolboxDropzone.addEventListener('dragleave', handleUnifiedLeave);
            toolboxDropzone.addEventListener('drop', handleUnifiedDrop);
        }

        // --- GAME FLOW ---
        function startGame() {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            setTimeout(() => {
                overlays.activityDescription.classList.remove('hidden');
                if (sounds.intro) playSound(sounds.intro);
            }, 500);
        }

        function closeActivityDescription() {
            overlays.activityDescription.classList.add('hidden');
            if (sounds.intro) sounds.intro.pause();
        }
        
        // --- UNIFIED DRAG & DROP HANDLERS ---
        function handleUnifiedStart(e) {
            e.stopPropagation();
            const card = e.target.closest('.strategy-card');
            if (!card) return;
            currentlyDragging = card;
            currentlyDragging.classList.add('dragging');
            if (!isTouchDevice) {
                e.dataTransfer.setData('text/plain', card.id);
            }
        }

        function handleUnifiedOver(e) {
            e.preventDefault();
            if (currentlyDragging) {
                toolboxDropzone.classList.add('drag-over');
            }
        }

        function handleUnifiedLeave() {
            toolboxDropzone.classList.remove('drag-over');
        }

        function handleUnifiedDrop(e) {
            e.preventDefault();
            toolboxDropzone.classList.remove('drag-over');
            if (!currentlyDragging) return;
            
            processDrop(currentlyDragging);
        }

        function handleUnifiedMove(e) {
            if (!currentlyDragging) return;
            e.preventDefault();
            const touch = e.touches[0];
            const dropzoneRect = toolboxDropzone.getBoundingClientRect();
            
            if (touch.clientX > dropzoneRect.left && touch.clientX < dropzoneRect.right &&
                touch.clientY > dropzoneRect.top && touch.clientY < dropzoneRect.bottom) {
                toolboxDropzone.classList.add('drag-over');
            } else {
                toolboxDropzone.classList.remove('drag-over');
            }
        }

        function handleUnifiedEnd() {
            if (!currentlyDragging) return;
            
            if (toolboxDropzone.classList.contains('drag-over')) {
                processDrop(currentlyDragging);
            }
            
            // Cleanup
            toolboxDropzone.classList.remove('drag-over');
            currentlyDragging.classList.remove('dragging');
            currentlyDragging = null;
        }

        // --- SHARED DROP LOGIC ---
        function processDrop(droppedElement) {
            const currentExpanded = toolboxDropzone.querySelector('.strategy-card.expanded');
            if (currentExpanded) {
                currentExpanded.classList.remove('expanded');
            }
            
            toolboxDropzone.appendChild(droppedElement);
            droppedElement.classList.add('expanded');
            
            const activityId = droppedElement.id;
            if (!completedActivities.has(activityId)) {
                playSound(sounds.ding);
                completedActivities.add(activityId);
                updateProgress();
            }

            if (completedActivities.size === TOTAL_ACTIVITIES) {
                setTimeout(() => {
                    gameScreen.classList.add('hidden');
                    completionOverlay.classList.remove('hidden');
                    if (sounds.outro) playSound(sounds.outro);
                }, 1000);
            }
        }
        
        // --- CARD CLICK LOGIC ---
        function handleCardClick(card) {
            if (toolboxDropzone.contains(card)) {
                const otherCards = toolboxDropzone.querySelectorAll('.strategy-card.expanded');
                otherCards.forEach(c => {
                    if(c !== card) {
                        c.classList.remove('expanded');
                    }
                });
                card.classList.toggle('expanded');
            }
        }
        
        function restartGame() {
            if (sounds.outro) sounds.outro.pause();
            completedActivities.clear();
            completionOverlay.classList.add('hidden');
            keyTakeawaysOverlay.classList.add('hidden');
            // Navigate to the game screen and reinitialize the activity
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            initializeGame();
            // Ensure hint button visibility is reset if applicable
            try { if (typeof showHintButton === 'function') showHintButton(); } catch (e) { /* ignore */ }
        }

   
        // --- UI & FEEDBACK ---
        function updateProgress() {
            const progress = (completedActivities.size / TOTAL_ACTIVITIES) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${completedActivities.size} / ${TOTAL_ACTIVITIES}`;
        }

        // --- MODAL CONTROLS ---
        function showGameInstructions() { overlays.gameInstructions.classList.remove('hidden'); }
        
        // --- HINT BUTTON & MODAL HANDLERS (copied behavior from ACTIVITY2) ---
        const hintButton = document.getElementById('hint-button');
        const hintModalOverlay = document.getElementById('hint-modal-overlay');
        const hintModalBtn = document.getElementById('hint-modal-btn');

        function showHintButton() {
            if (hintButton) hintButton.classList.remove('hidden');
        }

        if (hintButton) hintButton.addEventListener('click', () => {
            hintModalOverlay.classList.remove('hidden');
        });
        if (hintModalBtn) hintModalBtn.addEventListener('click', () => {
            hintModalOverlay.classList.add('hidden');
        });

        const originalStartGame = startGame;
        function startGameWithHint() {
            originalStartGame();
            setTimeout(showHintButton, 300);
        }
        
        const startBtn = document.querySelector('#start-screen .start-button');
        if (startBtn) {
            startBtn.removeAttribute('onclick');
            startBtn.addEventListener('click', () => {
                startGameWithHint();
                try { sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Build Your Self-Esteem Toolkit' }); } catch(e) { /* ignore */ }
            });
        }
        function goToNextActivity(){
            if (sounds.outro) sounds.outro.pause();
            window.location.href = '../ACTIVITY2/index.html'; // Update with actual next activity URL
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Build Your Self-Esteem Toolkit' });
        }
        function closeGameInstructions() { overlays.gameInstructions.classList.add('hidden'); }
        
        // --- UTILITIES ---
        function playSound(audioEl) {
            if (audioEl) {
                audioEl.currentTime = 0;
                audioEl.play().catch(e => console.error('Audio play failed:', e));
            }
        }
    </script>
     <script src="../eventSender.js"></script>
</body>
</html>