<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Values Spotlight – Hotspot Explorer</title>
    <style>
        /* Font Imports */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar {
            display: none;
        }
        /* Root Variables */
        :root {
             --font-xs: 1.1rem;
            --font-sm: 1.4rem;
            --font-md: 1.4rem;
            --font-lg: 2rem;
            --font-xl: 4rem;
            --pad-sm: 1rem;
            --pad-md: 1.6rem;
            --pad-lg: 2.4rem;
            --primary-color: #5D04B2;
            --secondary-color: #fbb03b;
            --progress-color: #ffff00;
            --correct-color: #4caf50;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --header-font: 'Fredoka', sans-serif;
            --body-font: var(--header-font);
        }

        /* Proportional Scaling System Setup */
        html {
            /* Establishes a master scaling unit relative to the viewport's smallest dimension. */
            font-size: 1.8vmin;
        }

        /* Global Reset & Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent body scrollbars */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f4f8;
            font-family: var(--body-font);
        }

        #game-wrapper {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
            max-width: 1200px;
            margin: auto;
            position: relative;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background-color: var(--primary-color);
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            overflow: hidden;
            padding: 1rem;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }


    /* ===== START SCREEN ===== */
    #start-screen {
      color: var(--text-color-light);
      text-align: center;
      padding: 2rem;
      background-image: url('images/gamebg.jpg');
      background-size: cover;
      background-position: center;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    #start-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    #start-screen h1, #start-screen .start-button {
        position: relative;
        z-index: 1;
    }

    #start-screen h1 {
      color: var(--text-color-light);
      font-size: 4rem;
      font-family: var(--header-font);
      text-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.4);
      font-weight: 500;
    }

    .start-button {
       font-family: var(--header-font);
        background: var(--secondary-color);
        color: var(--text-color-light);
        font-weight: 500;
        font-size: 1.2rem;
        border: 3px solid #fff;
        border-radius: 4.8rem;
        padding: var(--pad-sm) var(--pad-lg);
        margin-top: 1.6rem;
        cursor: pointer;
        text-shadow: 0 0.2rem 0 #b88b2a;
        transition: all 0.2s;
    }

    .start-button:hover {
      transform: scale(1.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
    }

        /* Game Screen Styles */
        #game-screen {
             justify-content: flex-start;
             padding: 0;
             display: flex;
             flex-direction: column;
        }

        /* Header / Top Bar */
        .game-top-section {
          width: 100%;
          background-color: #5D04B2;
          padding: 0.75rem 1.25rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: #fff;
          z-index: 10;
          box-shadow: 0 0.1rem 0.5rem rgba(0,0,0,0.2);
          flex-shrink: 0;
        }

        #game-title {
          font-size: 1.8rem;
          font-weight: 600;
          margin: 0;
        }

        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        /* Progress Bar */
         #progress-container {
            width: 12.5rem;
            background-color: rgba(255,255,255,0.3);
            border-radius: 1rem;
            height: 1.25rem;
            border: 2px solid #fff;
            position: relative;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #FFFF00;
            border-radius: 0.8rem;
            transition: width 0.5s ease;
        }

        #progress-text {
            color: var(--text-color-light);
            font-weight: 700;
            font-size: 1rem;
            text-shadow: 0.0625rem 0.0625rem 0.125rem rgba(0,0,0,0.6);
            white-space: nowrap;
        }

        @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 1rem rgba(255, 255, 255, 0.7), 0 0 2rem rgba(255, 255, 255, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 2rem rgba(255, 255, 255, 1), 0 0 3rem rgba(255, 255, 255, 0.7); transform: scale(1.1); }
        }

        .instructions-icon {
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.2);
            border: 0.15rem solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            flex-shrink: 0;
            animation: glow-pulse-white 2s infinite ease-in-out;
        }
        .instructions-icon svg { width: 60%; height: 60%; fill: white; }
        .instructions-icon:hover {
            transform: scale(1.1);
            animation-play-state: paused;
        }

        .lab-game-area {
            width: 100%;
            flex-grow: 1;
            position: relative;
            background-image: url('images/hotspot-img.jpg');
            background-size: cover;
            background-position: bottom center;
            background-repeat: no-repeat;
            background-color: #fafafa;
        }

        .hotspot {
            position: absolute;
            cursor: pointer;
            z-index: 2;
            width: 8%;
            height: 15%;
            border-radius: 50%;
            background-color: rgba(255, 255, 0, 0.2);
            border: 0.2rem solid white;
            transform: translate(-50%, -50%); /* Center the hotspot */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, background-color 0.3s ease, border-color 0.3s ease;
        }

        .hotspot.visible {
            opacity: 1;
            visibility: visible;
        }

        @keyframes zone-pulse {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0rem rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 1.5rem rgba(255, 255, 255, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0rem rgba(255, 255, 255, 0); }
        }

        .hotspot.active { animation: zone-pulse 1.5s infinite; }
        .hotspot.completed::before {
            content: '✓';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: white;
            font-weight: 700;
            text-shadow: 0 0.1rem 0.3rem rgba(0,0,0,0.5);
        }
        .hotspot.completed {
            pointer-events: none;
            background-color: rgba(76, 175, 80, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            animation: none;
        }

        /* MODALS */
        .overlay {
          position: absolute; top: 0; left: 0; width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.4);
          backdrop-filter: blur(0.5rem);
          z-index: 100;
          display: flex; justify-content: center; align-items: center;
          animation: fadeIn 0.3s ease;
        }
        .overlay.hidden { display: none; }

        .modal {
          background: var(--card-background-light, #fff);
          padding: 2.5rem;
          border-radius: 1rem;
          text-align: center;
          width: 90%;
          max-width: 50rem;
          animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          position: relative;
        }

        .modal .modal-title {
          font-size: 2.5rem; font-weight: 600; margin-bottom: 1.5rem;
          color: var(--primary-color);
        }
        .modal p { font-size: 1.5rem; line-height: 1.6; color: var(--text-color-dark, #333); }

        #activity-description-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #activity-description-overlay .modal .modal-title { color: var(--primary-color); }
        #activity-description-overlay .modal p {
          text-align: left; background: #f8f9fa; padding: 1.5rem;
          border-radius: 0.75rem; border-left: 0.4rem solid var(--primary-color);
        }

        #game-instructions-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #game-instructions-overlay .modal .modal-title { color: var(--primary-color); }
        #game-instructions-overlay .modal p {
            text-align: left;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.2rem; line-height: 1.6;
        }

        .modal-close-btn {
          width: 100%; padding: 1.2rem; font-size: 1.5rem; font-weight: 700;
          border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
          background-color: var(--primary-color);
          transition: transform 0.2s, box-shadow 0.2s;
          margin-top: 1.5rem;
        }

        .modal-close-btn:hover { transform: scale(1.02); }

        /* Scenario Info Modal */
        .scenario-modal {
            background: var(--card-background-light);
            width: 90%;
            max-width: 60rem; /* Adjusted max-width */
            max-height: 90vh;
            border-radius: 1rem;
            overflow: hidden;
            animation: slideIn 0.6s ease;
            display: flex;
            flex-direction: column;
        }

        .scenario-content {
            padding: 2.5rem;
            overflow-y: auto;
        }

        #scenario-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            font-family: var(--header-font);
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 600;
        }

        .scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.5rem;
            text-align: left;
        }

        .scenario-table th, .scenario-table td {
            padding: 1.2rem;
            border-bottom: 1px solid #dee2e6;
        }

        .scenario-table th {
            width: 35%;
            font-weight: 600;
            background-color: #f8f9fa;
            color: var(--primary-color);
        }

        .scenario-table tr:last-child th,
        .scenario-table tr:last-child td {
            border-bottom: none;
        }

        #scenario-close-btn {
           margin: 1.5rem 2.5rem 2.5rem;
           width: 91%;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(3rem) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* Completion Overlay Styles */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .completion-title-banner { 
            color: var(--text-color-light);
            font-size: clamp(2rem, 10vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        #completion-overlay .modal {
            background: transparent; box-shadow: none; padding: 0; overflow: visible;
            width: auto; max-width: none;margin-bottom: 4rem;
        }
        #completion-image { 
            width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
            border: 3px solid var(--secondary-color); border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 0.5rem;
        }
        .completion-buttons {
            position: absolute; bottom: 1.5rem; width: 100%; display: flex;
            justify-content: space-between; gap: 1.5rem; padding: 0 2rem;
        }
        .completion-btn {
        font-family: var(--header-font); background: var(--secondary-color); color: #fff;
            font-weight: 500; font-size: 1.3rem; border: 0.1875rem solid #fff; border-radius: 3rem; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            cursor: pointer; transition: all 0.2s; box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none; min-width: 8.75rem;
        }
        .completion-btn:hover { transform: scale(1.05); }
        
        /* ====== KEY TAKEAWAYS SCREEN ====== */
        .end-lesson-screen {
            display: flex; flex-direction: column; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; justify-content: center; align-items: center;
            padding: 2rem; background-color: var(--primary-color); text-align: center; color: white; gap: 1.5rem;
            z-index: 300;
        }
        .end-lesson-screen h2 { font-size: 2.5rem; text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.2); }
        #key-takeaways-overlay{
            background-image: url(images/gamebg.jpg);
            background-size: cover;
            background-position: center;
        }
        #key-takeaways-overlay::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
        }
        #key-takeaways-overlay > * {
            position: relative;
            z-index: 1;
        }
        .takeaways-container {
            background-color: white; color: var(--text-color-dark);
            border-radius: 1rem; padding: 1.5rem 2rem; max-width: 50rem;
            width: 90%; border-top: 0.3rem solid var(--secondary-color);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
        }
        .takeaways-title { font-size: 2rem; color: var(--primary-color); margin-bottom: 1.2rem; font-weight: 700; }
        .takeaways-list { list-style-type: none; padding: 0; text-align: left; }
        .takeaways-list li { position: relative; padding-left: 2rem; margin-bottom: 0.8rem; font-size: 1.2rem; line-height: 1.5; }
        .takeaways-list li::before { content: "✓"; color: var(--correct-color); position: absolute; left: 0; top: 0; font-size: 1.2rem; font-weight: bold; }
        .primary-action-btn {
            background: var(--secondary-color); color: #fff; font-weight: 900; font-size: 1.25rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; padding: 0.75rem 2.5rem;
            cursor: pointer; text-shadow: 0 0.125rem 0 #b88b2a; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2); text-decoration: none;
        }
        .primary-action-btn:hover { transform: scale(1.06); }

        /* MEDIA QUERIES */
        @media (max-aspect-ratio: 16/9) {
            #game-wrapper {
                max-height: 100%;
                max-width: calc(100vh * 16 / 9);
            }
        }
        @media (max-width: 1200px) {
            html {
                font-size: 2.2vmin;
            }
        }

        @media (max-width: 1000px) {
            html{
                font-size: 3vmin;
            }
            #game-wrapper {
                width: 100vw; height: 100vh; min-width: 100vw; min-height: 100vh;
                border-radius: 0; max-width: none; aspect-ratio: unset;
            }
            #completion-image{
                max-width: 63%;
            }
        }
        @media (min-width:769px) and (max-width:999px) {
            .lab-game-area {
                background-position: center;
            }
            
        }
        @media (max-width: 768px) {
             html {
                font-size: 3vmin;
            }
            .completion-header { font-size: 3rem; }
            .completion-buttons-footer {
                gap: 1rem;
                bottom: 1rem;
                flex-direction: column;
            }
            .scenario-content {
                padding: 1.5rem;
            }
            #scenario-close-btn {
                margin: 1.5rem 2.5rem 2.5rem;
                justify-content: center;
                text-align: center;
                width: 92%;
            }
            #scenario-title { font-size: 1.8rem; }
            .scenario-table { font-size: 1.2rem; }
            .scenario-table th, .scenario-table td { padding: 0.8rem; }
            .takeaways-list li { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="start-screen" class="screen">
                <h1>Values Spotlight</h1>
                <button class="start-button" onclick="startGame();">Start Activity</button>
            </div>

            <div id="game-screen" class="screen hidden">
                <div class="game-top-section">
                    <h1 id="game-title">Values Spotlight</h1>
                    <div class="progress-wrapper">
                         <div id="progress-container">
                            <div id="progress-bar"></div>
                        </div>
                        <div id="progress-text">0 / 4</div>
                        <div class="instructions-icon" onclick="showGameInstructions()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="lab-game-area" id="lab-game-area">
                    </div>
            </div>

            <div id="activity-description-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Activity Introduction</h2>
                    <p>Every action in your project reflected a value. In this activity, you will explore a project scene and discover the values hidden in everyday actions.</p>
                    <button class="modal-close-btn" onclick="closeActivityDescription();">Continue</button>
                </div>
            </div>

            <div id="game-instructions-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Learner Instructions</h2>
                    <p>Click each hotspot in the picture. Read the explanation of the value shown.</p>
                    <button class="modal-close-btn" onclick="closeGameInstructions()">Got It!</button>
                </div>
            </div>

            <div id="scenario-overlay" class="overlay hidden">
                 <div class="scenario-modal">
                    <div class="scenario-content">
                        <h2 id="scenario-title"></h2>
                        <div id="scenario-info"></div>
                    </div>
                    <button id="scenario-close-btn" class="modal-close-btn" onclick="closeScenario()">Continue</button>
                </div>
            </div>

            <div id="completion-overlay" class="overlay hidden">
            <div class="completion-title-banner">Activity conclusion!</div>
            <div class="modal">
                <img id="completion-image" src="images/complete.jpg" alt="Activity Complete" onerror="this.style.display='none'">
            </div>
            <div class="completion-buttons">
                <button class="completion-btn" onclick="restartGame()">Restart Activity</button>
                <button class="completion-btn" onclick="goToNextActivity()">Next Activity</button>
            </div>
        </div>

            <div id="key-takeaways-overlay" class="screen hidden end-lesson-screen">
                <h2>Well Done!</h2>
                <div class="takeaways-container">
                    <div class="takeaways-title">Key Takeaways</div>
                    <ul class="takeaways-list">
                        <li>Service is not just about actions, but also the values behind them.</li>
                        <li>Values like kindness, responsibility, and respect make service meaningful.</li>
                        <li>Working together and sharing with others demonstrates teamwork and generosity.</li>
                        <li>Observing actions can help identify underlying positive values in a community.</li>
                    </ul>
                </div>
                <button class="primary-action-btn" onclick="closeKeyTakeaways()">Exit Lesson</button>
            </div>
        </div>
    </div>

    <audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
    <audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
    <audio id="outro-audio" src="audio/outro.mp3" preload="auto"></audio>

    <script>
        // --- DATA ---
        const activityData = [
            {
                id: 'sharing-shovel',
                title: 'Sharing a Shovel',
                value: 'Sharing',
                explanation: 'Sharing tools shows generosity and fairness.',
                coords: { top: '80%', left: '20%', width: '20%', height: '25%' }
            },
            {
                id: 'group-singing',
                title: 'Group Singing',
                value: 'Teamwork',
                explanation: 'Singing together builds unity and motivation.',
                coords: { top: '25%', left: '35%', width: '20%', height: '35%' }
            },
            {
                id: 'talking-elder',
                title: 'Talking to an Elder',
                value: 'Respect',
                explanation: 'Respect is shown by listening and valuing wisdom.',
                coords: { top: '20%', left: '75%', width: '15%', height: '40%' }
            },
            {
                id: 'writing-journal',
                title: 'Writing in a Journal',
                value: 'Responsibility',
                explanation: 'Recording experiences shows accountability.',
                coords: { top: '70%', left: '60%', width: '12%', height: '25%' }
            }
        ];
        const TOTAL_ACTIVITIES = activityData.length;

        // --- STATE ---
        let completedActivities = new Set();
        let activeActivity = null;
        let hotspotTimeouts = [];

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const completionOverlay = document.getElementById('completion-overlay');
        const keyTakeawaysOverlay = document.getElementById('key-takeaways-overlay');
        const labGameArea = document.getElementById('lab-game-area');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const overlays = {
            activityDescription: document.getElementById('activity-description-overlay'),
            gameInstructions: document.getElementById('game-instructions-overlay'),
            scenario: document.getElementById('scenario-overlay'),
        };
        const sounds = {
            ding: document.getElementById('ding-sound'),
            intro: document.getElementById('intro-audio'),
            outro: document.getElementById('outro-audio'),
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupGame();
        });

        function setupGame() {
            labGameArea.innerHTML = '';
            hotspotTimeouts.forEach(clearTimeout);
            hotspotTimeouts = [];

            activityData.forEach((item, index) => {
                const hotspot = document.createElement('div');
                hotspot.className = 'hotspot';
                hotspot.id = item.id;
                hotspot.dataset.index = index;
                Object.assign(hotspot.style, item.coords);
                labGameArea.appendChild(hotspot);
            });
            updateHotspotStates();
            updateProgress();
            // Avoid adding duplicate listeners when setupGame is called multiple times
            labGameArea.removeEventListener('click', handleHotspotClick);
            labGameArea.addEventListener('click', handleHotspotClick);
        }

        // --- GAME FLOW ---
        function startGame() {
            sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Values Spotlight' });
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            setTimeout(() => {
                overlays.activityDescription.classList.remove('hidden');
                playSound(sounds.intro);
            }, 500);
        }

        function closeActivityDescription() {
            overlays.activityDescription.classList.add('hidden');
            if (sounds.intro) sounds.intro.pause();
            showHotspotsSequentially();
        }

        function showHotspotsSequentially() {
            const hotspots = document.querySelectorAll('.hotspot');
            hotspots.forEach((hotspot, index) => {
                const timeoutId = setTimeout(() => {
                    if(!hotspot.classList.contains('completed')) {
                       hotspot.classList.add('visible', 'active');
                    }
                }, (index) * 2000); // Appear every 2 seconds
                hotspotTimeouts.push(timeoutId);
            });
        }

        function handleHotspotClick(event) {
            const clickedHotspot = event.target.closest('.hotspot');
            if (!clickedHotspot || clickedHotspot.classList.contains('completed')) return;

            activeActivity = activityData[parseInt(clickedHotspot.dataset.index)];
            showScenarioInfo(activeActivity);
        }

        function showScenarioInfo(activity) {
            document.getElementById('scenario-title').textContent = activity.title;
            const infoContainer = document.getElementById('scenario-info');

            infoContainer.innerHTML = `
                <table class="scenario-table">
                    <tbody>
                        <tr>
                            <th>Value</th>
                            <td>${activity.value}</td>
                        </tr>
                        <tr>
                            <th>Explanation</th>
                            <td>${activity.explanation}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            overlays.scenario.classList.remove('hidden');
        }

        function closeScenario() {
            overlays.scenario.classList.add('hidden');

            if (activeActivity && !completedActivities.has(activeActivity.id)) {
                playSound(sounds.ding);
                completedActivities.add(activeActivity.id);
                updateProgress();
                updateHotspotStates();
            }

            activeActivity = null;

            if (completedActivities.size === TOTAL_ACTIVITIES) {
                 setTimeout(() => {
                     gameScreen.classList.add('hidden');
                     completionOverlay.classList.remove('hidden');
                     playSound(sounds.outro);
                 }, 800);
            }
        }

        function restartGame() {
            if (sounds.outro) sounds.outro.pause();
            // Reset state
            completedActivities.clear();
            activeActivity = null;
            hotspotTimeouts.forEach(clearTimeout);
            hotspotTimeouts = [];

            // Hide any overlays and completion UI
            completionOverlay.classList.add('hidden');
            keyTakeawaysOverlay.classList.add('hidden');
            overlays.scenario.classList.add('hidden');

            // Ensure the game screen is visible and start screen is hidden
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            // Rebuild hotspots and reset progress
            setupGame();
            
            // Hide the activity introduction overlay (we will show hotspots immediately on restart)
            overlays.activityDescription.classList.add('hidden');

            // Start showing hotspots immediately after restart
            setTimeout(() => {
                showHotspotsSequentially();
            }, 250);
        }
        function goToNextActivity() {
            if (sounds.outro) sounds.outro.pause();
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Values Spotlight' });
            window.location.href = '../ACTIVITY2/index.html'; // Replace with actual next activity URL
        }

        function closeKeyTakeaways() {
             // In a real implementation, this might go to a lesson menu.
             // For this example, we'll just go back to the start screen.
             keyTakeawaysOverlay.classList.add('hidden');
             startScreen.classList.remove('hidden');
             // Also reset the game state for a clean start
             completedActivities.clear();
             activeActivity = null;
             setupGame(); // Re-initializes hotspots but keeps them hidden
        }
        
        // --- UI & FEEDBACK ---
        function updateProgress() {
            const progress = (completedActivities.size / TOTAL_ACTIVITIES) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${completedActivities.size} / ${TOTAL_ACTIVITIES}`;
        }

        function updateHotspotStates() {
            document.querySelectorAll('.hotspot').forEach((hotspot) => {
                const activityId = hotspot.id;
                // Check if the hotspot corresponds to a completed activity
                if (completedActivities.has(activityId)) {
                    // If completed, add 'completed' class and remove 'active' class to stop the pulse
                    hotspot.classList.add('completed');
                    hotspot.classList.remove('active');
                } else if (hotspot.classList.contains('visible')) {
                    // If it's visible but not completed, ensure it has the 'active' class to pulse
                    hotspot.classList.add('active');
                }
            });
        }

        // --- MODAL CONTROLS ---
        function showGameInstructions() { overlays.gameInstructions.classList.remove('hidden'); }
        function closeGameInstructions() { overlays.gameInstructions.classList.add('hidden'); }

        // --- UTILITIES ---
        function playSound(audioEl) {
            if (audioEl) {
                audioEl.currentTime = 0;
                audioEl.play().catch(e => console.error('Audio play failed:', e));
            }
        }
    </script>
<script src ="../eventSender.js"></script>
</body>
</html>