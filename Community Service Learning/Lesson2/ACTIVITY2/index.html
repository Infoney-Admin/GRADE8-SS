<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Your Solution Plan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ====== FONT IMPORTS ====== */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar{
            display: none;
        }
        /* ====== ROOT VARIABLES & SCALING ====== */
        :root {
            --font-xs: 1.1rem;
            --font-sm: 1.4rem;
            --font-md: 1.4rem;
            --font-lg: 2rem;
            --font-xl: 4rem;
            --pad-sm: 1rem;
            --pad-md: 1.6rem;
            --pad-lg: 2.4rem;
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --border-radius: 1rem;
            --header-font: 'Fredoka', 'Poppins', sans-serif;
            --body-font: var(--header-font);
        }
        
        html {
             font-size: 1.8vmin;
        }

        /* ===== HIDE SCROLLBAR ===== */
        body::-webkit-scrollbar, .scenario-content::-webkit-scrollbar, .modal::-webkit-scrollbar { display: none; }
        body, .scenario-content, .modal { scrollbar-width: none; -ms-overflow-style: none; }

        /* ====== GLOBAL BASE ====== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: #f0f4f8;
            font-family: var(--body-font);
            overflow: hidden;
        }
        #game-wrapper {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9;
            overflow: hidden;
            display: flex; flex-direction: column; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        #game-container {
            width: 100%; height: 100%; background: #fff;
            position: relative; display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            pointer-events: all; visibility: visible;
        }
        .hidden { opacity: 0; pointer-events: none; visibility: hidden; }

        /* ===== START SCREEN ===== */
        #start-screen {
            color: var(--text-color-light); text-align: center; padding: 2rem;
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
        }
        #start-screen h1 {
          color: var(--text-color-light);
          font-size: 4rem;
          font-family: var(--header-font);
          font-weight: 500;
        }
        .start-button {
            font-family: var(--header-font);
            background: var(--secondary-color);
            color: var(--text-color-light);
            font-weight: 500;
            font-size: 1.2rem;
            border: 3px solid #fff;
            border-radius: 4.8rem;
            padding: var(--pad-sm) var(--pad-lg);
            margin-top: 1.6rem;
            cursor: pointer;
            text-shadow: 0 0.2rem 0 #b88b2a;
            transition: all 0.2s;
        }
    
        .start-button:hover { transform: scale(1.06); }


        /* ===== GAME SCREEN STYLES ===== */
        #game-screen { 
            justify-content: flex-start; 
            overflow: hidden; 
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .game-top-section {
            width: 100%; background-color: #5D04B2; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
            display: flex; justify-content: space-between; align-items: center;
            color: #fff; z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
    
        #game-title {
            font-weight: 600;
            margin: 0; font-family: var(--header-font);
        }
    
        .top-right-controls { display: flex; align-items: center; gap: 1rem; }
        
        #progress-container { 
            width: clamp(100px, 20vw, 200px); background-color: rgba(255,255,255,0.3);
            border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
            border: 2px solid #fff; position: relative; overflow: hidden;
        }
        #progress-bar {
            height: 100%; width: 0%; background: #FFFF00;
            border-radius: 0.8rem; transition: width 0.5s ease;
        }
        #progress-text {
            font-weight: 600; color: #fff;
            text-shadow: none;
        }

        .instructions-icon {
            width: 2.5rem; height: 2.5rem; background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            z-index: 15; flex-shrink: 0;
            animation: glow-pulse-white 2s infinite;
        }
        .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .instructions-icon svg { width: 1.25rem; height: 1.25rem; fill: white;}

        .hint-icon {
            position: absolute; bottom: 1.5rem; right: 1.5rem; width: 3.125rem; height: 3.125rem;
            background: var(--secondary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            z-index: 1001;
            border: 0.1875rem solid white;
            animation: glow-pulse 2s infinite;
        }
        .hint-icon:hover { transform: scale(1.1); }
        .hint-icon svg { fill: white; width: 1.5rem; height: 1.5rem; }

        /* ===== MODALS ===== */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .overlay.hidden { display: none; visibility: hidden; opacity: 0; }
        .modal {
            background: #fff; padding: 2.5rem; border-radius: 1rem;
            text-align: center; width: 90%; max-width: 600px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); } }

        .modal h2 {
            font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem;
            font-family: var(--header-font);
        }
        .modal p, .modal ul { font-size: 1.2rem; line-height: 1.6; color: var(--text-color-dark, #333); text-align: left; }
        .modal ul { list-style-type: none; padding: 0; }
        .modal li { margin-bottom: 0.8rem; }
        
        #activity-intro-overlay .modal { border-top: 8px solid var(--primary-color); }
        #activity-intro-overlay .modal h2 { color: var(--primary-color); }
        #activity-intro-overlay .modal p {
            text-align: left; background: #f8f9fa; padding: 1.5rem;
            border-radius: 0.75rem; border-left: 4px solid var(--primary-color);
        }
        
        #instructions-overlay .modal { border-top: 8px solid var(--primary-color); }
        #instructions-overlay .modal h2 { color: var(--primary-color); }
        #instructions-overlay .modal ol { text-align: left; padding-left: 2rem; font-size: 1.2rem; }

        #hint-overlay .modal { border-top: 8px solid var(--secondary-color); }
        #hint-overlay .modal h2 { 
            color: var(--secondary-color); display: flex; 
            align-items: center; justify-content: center; gap: 0.75rem; 
        }
        #hint-overlay ul { text-align: left; list-style-position: inside; }

        /* Modal Buttons */
        .modal button {
            width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700;
            border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
            transition: transform 0.2s, box-shadow 0.2s; margin-top: 1rem;
        }
        .modal button:hover { transform: scale(1.02); }
        #activity-intro-overlay button, #instructions-overlay button { background-color: var(--primary-color); }
        #hint-overlay button { background-color: var(--secondary-color); }

        /* Feedback Modals */
        .feedback-modal { max-width: 480px; }
        .feedback-modal p { text-align: center; font-size: 1.3rem; }
        .feedback-header { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; }
        .feedback-header h2 { font-size: 2rem; font-weight: 700; }
        .feedback-header.correct h2 { color: var(--correct-color); }
        .feedback-header.incorrect h2 { color: var(--incorrect-color); }
        .feedback-btn.correct { background-color: var(--correct-color); }
        .feedback-btn.incorrect { background-color: var(--incorrect-color); }
        #feedback-correct-overlay .modal { border-top: 8px solid var(--correct-color); }
        #feedback-incorrect-overlay .modal { border-top: 8px solid var(--incorrect-color); }

        /* ===== COMPLETION SCREEN ===== */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
            color: #fff; display: flex; flex-direction: column; justify-content: center;
            align-items: center; gap: 1rem; padding: 1rem;
        }
        .completion-title-banner { 
             font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
            font-weight: 500;
        }
        #completion-overlay .modal { 
            background: transparent; box-shadow: none; width: auto; max-width: none;
            display: flex; justify-content: center; align-items: center;
            padding: 0; overflow: visible;
        }
        #completion-image { 
            width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
            border: 3px solid #FBB03B; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-top: 0.5rem;
        }
        .completion-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1.5rem;
            width: 100%;
            padding: 1rem 2rem;
        }
        .completion-btn {
            font-family: var(--header-font); background: var(--secondary-color); color: #fff;
            font-weight: 500; 
            font-size: 1.3rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none;
            min-width: 8.75rem; /* 140px */
        }
        .completion-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2);
        }
    
        /* ===== TAKEAWAYS OVERLAY ===== */
        #takeaways-overlay {
            background-image: url(images/gamebg.jpg); flex-direction: column; justify-content: center;
        }
        .takeaways-main-header {
            font-family: var(--header-font); color: white; font-size: 2.5rem;
            position: absolute; top: 5%; text-align: center; width: 100%;
            text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.3);
        }
        #takeaways-overlay .modal { max-width: 800px; padding: 2rem; display: flex; flex-direction: column; align-items: center; height: 45vh;
            overflow-y: auto; margin-top: 3rem;
        }
        .takeaways-header { color:var(--primary-color); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
        .takeaways-header h3 { font-family: var(--header-font); font-size: 1.8rem; color: var(--primary-color); }
        #takeaways-list { list-style-type: none; padding: 0; width: 100%; }
        #takeaways-list li {
            background: none;
            border-left: none;
            margin-bottom: 0rem;
            padding: 1rem 1rem 1rem 2.5rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            text-align: left;
            position: relative;
        }
        #takeaways-list li::before {
            content: '';
            display: inline-block;
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.2rem;
            height: 1.2rem;
            background: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%235cb85c" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 10.8 17 4 10.8"/></svg>');
            background-size: 1.2rem 1.2rem;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .end-lesson-btn
        {
            background: var(--secondary-color);
            font-family: var(--header-font);
            color: #fff;
            font-weight: 500;
            font-size: 1.3rem;
            border: 3px solid #fff;
            border-radius: 3rem;
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            text-shadow: 0 2px 0 #b88b2a;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: auto;
            min-width: 180px;
            margin-top: 2rem;
        }
        .end-lesson-btn:hover { transform: scale(1.06); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }

        /* ===== SCENARIO LAYOUT ===== */
        .scenario-title {
            font-family: var(--header-font); color: var(--primary-color);
            font-size: 2.2rem; text-align: center; padding: 1rem;
            width: 100%; margin-bottom: 0.5rem; flex-shrink: 0;
        }
        .scenario-content {
            flex: 1; padding: 1rem 2rem; overflow: hidden; display: flex;
            justify-content: center; align-items: center; margin-top: 0;
        }
        .scenario-container {
            display: flex; gap: 2rem; align-items: stretch; width: 100%;
            max-width: 80rem; padding: 1rem;
            opacity: 1; transition: opacity 0.3s ease-in-out; height: 55vh;
        }
        .scenario-container.fade-out { opacity: 0; }
        
        .scenario-details { flex: 1 1 50%; display: flex; flex-direction: column; }
        .scenario-story { 
            font-size: 1.3rem; color: #444; line-height: 1.7; 
            background: #f8f9fa; border-left: 0.25rem solid var(--primary-color); 
            padding: 1.5rem; border-radius: 0.8rem; text-align: left; width: 100%; 
            flex-grow: 1; overflow-y: auto;
        }
        
        .plan-form-section {
            flex: 1 1 80%; display: grid;
            grid-template-columns: repeat(2, auto); row-gap: 1.5rem;
            gap: 1.2rem; width: 100%; background-color: #f2f0f5;
            padding: 1.5rem; border-radius: var(--border-radius);
            overflow-y: auto;
        }
        .field-group h3 { 
            font-family: var(--header-font);
             color: var(--text-color-dark); 
             font-size: 1.5rem;
              margin-bottom: 0.8rem;
               text-align: left; 
             font-weight: 500;
            text-decoration: underline;
            }

        
        .options-container { display: flex; flex-direction: column; gap: 0.8rem; width: 100%; }
        .option-button {
            background: #fff; border: 2px solid #ddd; border-radius: 1rem; padding: 1rem; cursor: pointer;
            transition: all 0.3s ease; font-size: 1.1rem; color: var(--text-color-dark); font-weight: 400;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); text-align: left;
        }
        .option-button:hover:not(:disabled) { transform: translateY(-2px); border-color: var(--primary-color); }
        .option-button.correct { background: var(--correct-color); color: white; border-color: #fff; transform: scale(1.02); }
        .option-button.incorrect { background: var(--incorrect-color); color: white; animation: shake 0.5s; }
        .option-button:disabled { cursor: not-allowed; opacity: 0.7; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }

        /* ===== Glowing Pulsating Effect Keyframes ====== */
        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 10px rgba(251,176,59,0.5), 0 0 20px rgba(251,176,59,0.3); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(251,176,59,0.8), 0 0 30px rgba(251,176,59,0.5); transform: scale(1.1); } }
        @keyframes glow-pulse-white { 0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(255,255,255,0.5); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 30px rgba(255,255,255,0.7); transform: scale(1.1); } }

        /* ===== RESPONSIVE DESIGN ===== */
        @media(min-width: 1200px) { 
            .scenario-story { font-size: 1.4rem; line-height: 1.8; height: 35vh; flex-grow: 0; }
        }

        @media (max-width: 1199px) {
            .scenario-story{
                flex-grow: 0;
                height: 30vh;
            }
        }
        @media (max-width: 1024px) {
        }
        @media (max-width: 991px) {
                        #game-wrapper { width: 100vw; height: 100vh; border-radius: 0; aspect-ratio: unset; }

            html{ font-size: 3vmin; }
            .scenario-container { 
               height: auto; max-height: calc(100% - 2rem); overflow-y: hidden; 
            }
            .scenario-details { flex-shrink: 0; }
            .scenario-story { max-height: 25vh; }
            .plan-form-section { flex-grow: 1; }
            .completion-buttons { align-items: center; }
            #takeaways-overlay .modal{ height: 60vh }
        }
        @media (max-width: 768px) {
            html { font-size: 3.3vmin; }
            .scenario-title { font-size: 1.8rem; }
            .scenario-content { padding: 1rem; }
            .completion-title-banner { font-size: 1.8rem; }
            #completion-image { max-width: 66%; }
            .completion-btn { min-width: 155px; }
            .field-group h3 { font-size: 1.2rem; }
            .option-button{ font-size: 1rem; padding: 1rem; }
            .scenario-story{
                max-height: 46vh;
            }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-container">
        <div id="start-screen" class="screen">
            <h1>Build Your Solution Plan</h1>
            <button class="start-button" onclick="showActivityIntro();">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
                <h1 id="game-title">Solution Planning</h1>
                <div class="top-right-controls">
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>
                    <span id="progress-text">0 / 4</span>
                    <div class="instructions-icon" onclick="showInstructions()">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </div>
                </div>
            </div>

            <h2 class="scenario-title" id="scenario-title"></h2>
            
            <div class="scenario-content">
                <div class="scenario-container" id="scenario-container">
                    <div class="scenario-details">
                        <p class="scenario-story" id="scenario-story-text"></p>
                    </div>
                    <div class="plan-form-section" id="plan-form-section">
                        </div>
                </div>
            </div>
            
            <div class="hint-icon" id="hint-icon" onclick="showHint()">
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"></path></svg>
            </div>
        </div>

        <div id="completion-overlay" class="overlay hidden">
            <h2 class="completion-title-banner">Activity Conclusion!</h2>
            <img id="completion-image" src="images/complete.jpg" alt="Activity Complete Summary">
            <div class="completion-buttons">
                <button class="completion-btn btn-prev" onclick="goToPreviousActivity()">Previous Activity</button>
                <button class="completion-btn btn-restart" onclick="restartGame()">Restart Activity</button>
                <button class="completion-btn btn-next" onclick="showTakeaways()">Key Takeaways</button>
            </div>
        </div>

        <div id="takeaways-overlay" class="overlay hidden">
            <h2 class="takeaways-main-header">Lesson Complete</h2>
            <div class="modal">
                <div class="takeaways-header">
                    <h3>Key Takeaways</h3>
                </div>
                <ul id="takeaways-list"></ul>
            </div>
            <button class="end-lesson-btn" onclick="sendEvent(LessonEvent.END_LESSON, {lessonName: 'Designing Solutions to the Identified Community Problem: Lesson 2'})">Exit Lesson</button>
        </div>

        <div id="activity-intro-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Activity Introduction</h2>
                <p id="intro-text"></p>
                <button onclick="closeModal('activity-intro-overlay')">Continue</button>
            </div>
        </div>

        <div id="instructions-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Instructions</h2>
                <ol id="instructions-list"></ol>
                <button onclick="closeModal('instructions-overlay')">Got it!</button>
            </div>
        </div>
        
        <div id="hint-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Here's a hint</h2>
                <ul id="hint-list"></ul>
                <button onclick="closeModal('hint-overlay')">Got it!</button>
            </div>
        </div>
        
        <div id="feedback-correct-overlay" class="overlay hidden">
            <div class="modal feedback-modal">
                <div class="feedback-header correct">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--correct-color)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:2rem;height:2rem;margin-right:0.5rem;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <h2>Correct!</h2>
                </div>
                <p id="correct-feedback-text"></p>
                <button class="feedback-btn correct" onclick="closeCorrectFeedbackAndCheck()">Continue</button>
            </div>
        </div>
        
        <div id="feedback-incorrect-overlay" class="overlay hidden">
            <div class="modal feedback-modal">
                <div class="feedback-header incorrect">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--incorrect-color)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="width:2rem;height:2rem;margin-right:0.5rem;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                    <h2>Not Quite...</h2>
                </div>
                <p id="incorrect-feedback-text"></p>
                <button class="feedback-btn incorrect" onclick="closeIncorrectFeedback()">Try Again</button>
            </div>
        </div>
    </div>
</div>

<script>
    const activityData = {
        title: "Build Your Solution Plan",
        introduction: "Every successful project begins with a plan. In this activity, you will design a detailed solution plan with steps, resources, and team roles.",
        instructions: [
            "Read the problem described in each scenario.",
            "For each part of the plan, select the best option (A or B).",
            "You will receive immediate feedback on each choice.",
            "You must select all correct options to move to the next scenario."
        ],
        hints: [
            "Think of what comes first, second, and third in your plan.",
            "Be realistic with the materials needed and the roles assigned.",
            "Each step should move you closer to solving the problem."
        ],
        keyTakeaways: [
            "Solutions must be realistic, achievable, and community-focused. For example: planting trees for drought, shoe donations for jiggers, or awareness campaigns for substance abuse.",
            "Research helps us learn from communities that solved similar problems.",
            "A good solution uses teamwork, available resources, and community support."
        ],
        scenarios: [
            {
                title: "Scenario 1: Community Health",
                problem: "In a nearby community, many children are suffering from jigger infestations, which causes them pain and prevents them from attending school.",
                fields: [
                    {
                        label: "Solution",
                        options: [
                            { text: "Shoe donation campaign", isCorrect: true, feedback: "Correct. Donating shoes directly prevents jigger infestation." },
                            { text: "Conduct a one-day health seminar", isCorrect: false, feedback: "Not correct. While helpful, this solution doesn't directly reduce or prevent jigger attacks." }
                        ]
                    },
                    {
                        label: "Steps to Take",
                        options: [
                            { text: "Collect shoes → Wash and disinfect → Distribute in schools", isCorrect: true, feedback: "Correct. These steps are realistic and practical." },
                            { text: "Ask for money → Buy shoes → Give them out", isCorrect: false, feedback: "Not correct. These steps are unclear or incomplete for carrying out the campaign effectively." }
                        ]
                    },
                    {
                        label: "Materials Needed",
                        options: [
                            { text: "Shoes, buckets, cleaning soap, posters", isCorrect: true, feedback: "Correct. These materials fully support the solution." },
                            { text: "First-aid kits and transportation", isCorrect: false, feedback: "Not correct. The listed materials are insufficient to support the campaign." }
                        ]
                    },
                    {
                        label: "Team Roles",
                        options: [
                            { text: "Collection team, Cleaning team, Distribution team", isCorrect: true, feedback: "Correct. Roles are divided clearly to ensure efficiency." },
                            { text: "One project manager for all tasks", isCorrect: false, feedback: "Not correct. The roles are not divided well enough to carry out the campaign effectively." }
                        ]
                    }
                ]
            },
            {
                title: "Scenario 2: Education Access",
                problem: "A significant number of students in the community are dropping out of school due to a lack of basic supplies and support.",
                fields: [
                    {
                        label: "Solution",
                        options: [
                            { text: "Peer mentoring and provision of school supplies", isCorrect: true, feedback: "Correct. Mentoring and resources encourage children to remain in school." },
                            { text: "Build a new classroom", isCorrect: false, feedback: "Not correct. This doesn't address the direct reasons (supplies and support) why learners are leaving." }
                        ]
                    },
                    {
                        label: "Steps to Take",
                        options: [
                            { text: "Identify vulnerable learners → Collect supplies → Pair mentors → Monitor progress", isCorrect: true, feedback: "Correct. The steps are structured and measurable." },
                            { text: "Tell students to find a mentor and buy books", isCorrect: false, feedback: "Not correct. The steps are not complete or realistic for solving dropout." }
                        ]
                    },
                    {
                        label: "Materials Needed",
                        options: [
                            { text: "Books, pens, uniforms, notebooks", isCorrect: true, feedback: "Correct. These materials reduce barriers to school attendance." },
                            { text: "Computers and projectors", isCorrect: false, feedback: "Not correct. The chosen materials are not the most direct and essential items needed to prevent dropout." }
                        ]
                    },
                    {
                        label: "Team Roles",
                        options: [
                            { text: "Mentor group, Supply collection group, Parent engagement team", isCorrect: true, feedback: "Correct. Roles match the problem and solution." },
                            { text: "Teachers only to manage everything", isCorrect: false, feedback: "Not correct. The roles are not balanced and would not support all parts of the plan." }
                        ]
                    }
                ]
            },
            {
                title: "Scenario 3: Environmental Challenge",
                problem: "Local farms are struggling because of a severe drought, leading to food shortages for the community.",
                fields: [
                     {
                        label: "Solution",
                        options: [
                            { text: "Rainwater harvesting project", isCorrect: true, feedback: "Correct. Harvesting rainwater ensures water availability during drought." },
                            { text: "Organise a community prayer day for rain", isCorrect: false, feedback: "Not correct. This solution does not provide a reliable, practical way of addressing water shortage." }
                        ]
                    },
                    {
                        label: "Steps to Take",
                        options: [
                            { text: "Identify collection points → Install gutters → Set up tanks → Train families", isCorrect: true, feedback: "Correct. These steps ensure effective water collection and use." },
                            { text: "Buy water tanks and wait for rain", isCorrect: false, feedback: "Not correct. The steps are incomplete and don't show how water will be collected and used." }
                        ]
                    },
                    {
                        label: "Materials Needed",
                        options: [
                            { text: "Water tanks, gutters, pipes, training leaflets", isCorrect: true, feedback: "Correct. These materials are directly linked to the solution." },
                            { text: "Shovels, seeds, and fertilizer", isCorrect: false, feedback: "Not correct. These are useful for farming but miss the essential items for rainwater harvesting." }
                        ]
                    },
                    {
                        label: "Team Roles",
                        options: [
                            { text: "Installation team, Training team, Maintenance team", isCorrect: true, feedback: "Correct. A clear division of tasks ensures sustainability." },
                            { text: "A single volunteer to oversee the project", isCorrect: false, feedback: "Not correct. The roles are not distributed well enough to install and maintain the project." }
                        ]
                    }
                ]
            },
            {
                title: "Scenario 4: Youth Well-being",
                problem: "There is a growing concern about substance abuse among young people in the community who lack positive recreational activities.",
                fields: [
                    {
                        label: "Solution",
                        options: [
                            { text: "Awareness campaign and youth sports clubs", isCorrect: true, feedback: "Correct. Awareness and activities give young people positive alternatives." },
                            { text: "Punish anyone found using substances", isCorrect: false, feedback: "Not correct. This solution doesn't provide clear awareness or positive alternatives for youth." }
                        ]
                    },
                    {
                        label: "Steps to Take",
                        options: [
                            { text: "Create awareness posters → Hold community meetings → Organise weekly football matches", isCorrect: true, feedback: "Correct. The plan combines education and activity effectively." },
                            { text: "Just tell the youth to stop", isCorrect: false, feedback: "Not correct. These steps do not create enough engagement or ongoing activity." }
                        ]
                    },
                    {
                        label: "Materials Needed",
                        options: [
                            { text: "Posters, footballs, sports kits, meeting space", isCorrect: true, feedback: "Correct. These resources support both the campaign and sports activities." },
                            { text: "Textbooks and a library", isCorrect: false, feedback: "Not correct. The materials listed are not suitable for this specific solution." }
                        ]
                    },
                    {
                        label: "Team Roles",
                        options: [
                            { text: "Campaign team, Sports organisers, Peer counsellors", isCorrect: true, feedback: "Correct. Multiple roles strengthen both prevention and support." },
                            { text: "The local government leader to handle it", isCorrect: false, feedback: "Not correct. The roles do not cover all the needs of the solution plan." }
                        ]
                    }
                ]
            }
        ]
    };

    let currentScenarioIndex = 0;
    const totalScenarios = activityData.scenarios.length;
    let introAudio, dingAudio, buzzAudio, outroAudio;
    let lastIncorrectFieldContainer = null;

    function initAudio() {
        try {
            introAudio = new Audio('audio/intro.mp3');
            dingAudio = new Audio('audio/ding.mp3');
            buzzAudio = new Audio('audio/buzz.mp3');
            outroAudio = new Audio('audio/outro.mp3');
        } catch (e) {
            console.warn("Audio could not be loaded.");
            const mockAudio = { play: () => {}, pause: () => {}, currentTime: 0 };
            introAudio = dingAudio = buzzAudio = outroAudio = mockAudio;
        }
    }

    function playSound(audio) { if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); } }
    function stopSound(audio) { if(audio) { audio.pause(); } }

    // Shuffle helper: Fisher-Yates
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function initGame() {
        loadScenario();
    }
    
    function loadScenario() {
        const scenario = activityData.scenarios[currentScenarioIndex];
        
        document.getElementById('scenario-title').textContent = scenario.title;
        document.getElementById('scenario-story-text').innerHTML = scenario.problem;
        
        const formContainer = document.getElementById('plan-form-section');
        formContainer.innerHTML = '';

        scenario.fields.forEach((field, fieldIndex) => {
            const fieldGroup = document.createElement('div');
            fieldGroup.className = 'field-group';

            const label = document.createElement('h3');
            label.innerHTML = field.label;
            fieldGroup.appendChild(label);

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            const optionLabels = ['A', 'B', 'C', 'D'];
            // Create a shuffled copy of the options so the original data order is preserved
            const shuffledOptions = shuffleArray([...field.options]);
            shuffledOptions.forEach((option, optionIndex) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.innerHTML = `<strong>${optionLabels[optionIndex]}.</strong> ${option.text}`;
                // Pass the option object directly so index references remain correct after shuffling
                button.onclick = () => handleOptionClick(button, fieldIndex, option);
                optionsContainer.appendChild(button);
            });
            
            fieldGroup.appendChild(optionsContainer);
            formContainer.appendChild(fieldGroup);
        });
        
        updateProgress();
    }

    function handleOptionClick(clickedButton, fieldIndex, option) {
        const optionsContainer = clickedButton.parentElement;
        optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);

        const chosenOption = option; // already passed in

        if (chosenOption.isCorrect) {
            playSound(dingAudio);
            clickedButton.classList.add('correct');
            showFeedbackPopup('correct', chosenOption.feedback);
        } else {
            playSound(buzzAudio);
            clickedButton.classList.add('incorrect');
            lastIncorrectFieldContainer = optionsContainer;
            showFeedbackPopup('incorrect', chosenOption.feedback);
        }
    }
    
    function checkCompletion() {
        const correctAnswers = document.querySelectorAll('.option-button.correct').length;
        const totalFields = activityData.scenarios[currentScenarioIndex].fields.length;
        if (correctAnswers === totalFields) {
            setTimeout(goToNextScenario, 300);
        }
    }

    function goToNextScenario() {
        const container = document.getElementById('scenario-container');
        container.classList.add('fade-out');
        setTimeout(() => {
            if (currentScenarioIndex < totalScenarios - 1) {
                currentScenarioIndex++;
                loadScenario();
                container.classList.remove('fade-out');
            } else {
                endActivity();
            }
        }, 300);
    }
    
    function updateProgress() {
        const progress = currentScenarioIndex;
        document.getElementById('progress-bar').style.width = `${(progress / totalScenarios) * 100}%`;
        document.getElementById('progress-text').textContent = `${progress} / ${totalScenarios}`;
    }

    function showFeedbackPopup(type, message) {
        document.getElementById(`${type}-feedback-text`).innerHTML = message;
        document.getElementById(`feedback-${type}-overlay`).classList.remove('hidden');
    }
    
    function showActivityIntro() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('activity-intro-overlay').classList.remove('hidden');
        playSound(introAudio);
        sendEvent(ActivityEvent.START_ACTIVITY, {activityName: 'Build Your Solution Plan'});
    }

    function showInstructions() { document.getElementById('instructions-overlay').classList.remove('hidden'); }
    
    function showHint() { document.getElementById('hint-overlay').classList.remove('hidden'); }

    function showTakeaways() { 
        document.getElementById('completion-overlay').classList.add('hidden');
        stopSound(outroAudio);
        document.getElementById('takeaways-overlay').classList.remove('hidden'); 
        sendEvent(ActivityEvent.END_ACTIVITY, {activityName: 'Build Your Solution Plan'});
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if (id === 'activity-intro-overlay') { 
            stopSound(introAudio); 
            initGame(); 
        }
    }

    function closeCorrectFeedbackAndCheck() {
        closeModal('feedback-correct-overlay');
        checkCompletion();
    }
    
    function closeIncorrectFeedback() {
        closeModal('feedback-incorrect-overlay');
        if (lastIncorrectFieldContainer) {
            lastIncorrectFieldContainer.querySelectorAll('.option-button').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('incorrect');
            });
            lastIncorrectFieldContainer = null;
        }
    }

    function endActivity() {
        document.getElementById('progress-bar').style.width = `100%`;
        document.getElementById('progress-text').textContent = `${totalScenarios} / ${totalScenarios}`;
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('completion-overlay').classList.remove('hidden');
        playSound(outroAudio);
    }
    
    function restartGame() {
        stopSound(outroAudio);
        document.getElementById('completion-overlay').classList.add('hidden');
        document.getElementById('takeaways-overlay').classList.add('hidden');
        currentScenarioIndex = 0;
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('scenario-container').classList.remove('fade-out');
        loadScenario();
    }

    function goToPreviousActivity() { 
        window.location.href = "../ACTIVITY1/index.html";
        stopSound(outroAudio);
        sendEvent(ActivityEvent.END_ACTIVITY, {activityName: 'Build Your Solution Plan'});
    }
    
    function populateStaticContent() {
        document.getElementById('intro-text').innerHTML = activityData.introduction;
        
        const instructionsList = document.getElementById('instructions-list');
        instructionsList.innerHTML = activityData.instructions.map(item => `<li>${item}</li>`).join('');

        const hintList = document.getElementById('hint-list');
        hintList.innerHTML = activityData.hints.map(item => `<li>${item}</li>`).join('');

        const takeawaysList = document.getElementById('takeaways-list');
        takeawaysList.innerHTML = activityData.keyTakeaways.map(item => `<li>${item}</li>`).join('');

        document.getElementById('progress-text').textContent = `0 / ${totalScenarios}`;
    }

    window.onload = () => { initAudio(); populateStaticContent(); };
</script>
<script src ="../eventSender.js"></script>
</body>
</html>